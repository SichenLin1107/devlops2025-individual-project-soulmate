services:
  mysql:
    container_name: ${PROJECT_NAME:-soulmate-dev}-mysql
    image: mysql:8
    restart: unless-stopped
    ports:
      - "${MYSQL_PORT:-3307}:3306"
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-soulmate_db_dev}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-dev123456}
      TZ: ${TZ:-Asia/Shanghai}
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    volumes:
      - mysql-dev-data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "--silent"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  phpmyadmin:
    container_name: ${PROJECT_NAME:-soulmate-dev}-phpmyadmin
    image: phpmyadmin:latest
    restart: unless-stopped
    ports:
      - "${PHPMYADMIN_PORT:-8082}:80"
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_ARBITRARY: 1
      UPLOAD_LIMIT: 50M
      TZ: ${TZ:-Asia/Shanghai}
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy

  backend:
    container_name: ${PROJECT_NAME:-soulmate-dev}-backend
    build:
      context: ../backend
      dockerfile: Dockerfile.dev
    image: ${PROJECT_NAME:-soulmate-dev}-backend:latest
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8081}:8081"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      DATASOURCE_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE:-soulmate_db_dev}?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&characterEncoding=UTF-8&useUnicode=true
      DATASOURCE_USERNAME: root
      DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-dev123456}
      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
      DEBUG: ${DEBUG:-true}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      ENABLE_SWAGGER: ${ENABLE_SWAGGER:-true}
      JWT_SECRET: ${JWT_SECRET:-dev_soulmate_jwt_secret_2025_32chars_min}
      RAG_SERVICE_URL: http://rag-service:8000
      TZ: ${TZ:-Asia/Shanghai}
    volumes:
      - backend-dev-logs:/app/logs
      - ../backend/src:/app/src:ro
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy

  rag-service:
    container_name: ${PROJECT_NAME:-soulmate-dev}-rag-service
    build:
      context: ../rag_service
      dockerfile: Dockerfile.dev
    image: ${PROJECT_NAME:-soulmate-dev}-rag-service:latest
    restart: unless-stopped
    ports:
      - "${RAG_SERVICE_PORT:-8000}:8000"
    environment:
      ENV: dev
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8000
      DEBUG: ${DEBUG:-true}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-dev123456}
      DB_NAME: ${MYSQL_DATABASE:-soulmate_db_dev}
      EMBEDDING_MODEL: embedding-2
      CHROMA_PERSIST_PATH: /app/data/chroma
      TZ: ${TZ:-Asia/Shanghai}
    volumes:
      - rag-service-dev-data:/app/data/chroma
      - ../rag_service/app:/app/app:ro
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy

  frontend:
    container_name: ${PROJECT_NAME:-soulmate-dev}-frontend
    build:
      context: ../frontend
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:${FRONTEND_PORT:-3000}"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      VITE_PORT: ${FRONTEND_PORT:-3000}
      VITE_HOST: 0.0.0.0
      VITE_PROXY_TARGET: http://backend:8081
    volumes:
      - ../frontend/src:/app/src
      - ../frontend/public:/app/public
    networks:
      - app-network
    depends_on:
      - backend

networks:
  app-network:
    driver: bridge
    name: ${PROJECT_NAME:-soulmate-dev}-network

volumes:
  mysql-dev-data:
    driver: local
    name: ${PROJECT_NAME:-soulmate-dev}-mysql-data
  backend-dev-logs:
    driver: local
    name: ${PROJECT_NAME:-soulmate-dev}-backend-logs
  rag-service-dev-data:
    driver: local
    name: ${PROJECT_NAME:-soulmate-dev}-rag-service-data
