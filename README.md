# SoulMate 心伴 - 用户使用说明

> 心理陪伴智能体开发与使用平台

---

## 一、项目简介

SoulMate 是一个面向心灵陪伴场景的 **AI 智能体开发与使用平台**，集成了智能体管理、知识库管理、工作流编排、LLM 模型管理、敏感词风控等功能。平台内置 8 类专业心理陪伴智能体和 5 个专业知识库，支持基于 RAG（检索增强生成）的知识问答。

### 技术架构

| 层级 | 技术栈 |
|-----|--------|
| 前端 | Vue 3 + Vue Router + Pinia + Element Plus + Tailwind CSS + Vue Flow |
| 后端 | Spring Boot 3.2 + Java 17 + MyBatis + JWT |
| RAG 服务 | Python 3.10+ + FastAPI + ChromaDB |
| 数据库 | MySQL 8.0 |
| 部署 | Docker + Docker Compose |

---

## 二、环境准备

### 系统要求

- **Docker Compose**：版本 2.0+
- **可用端口**：
  - 开发模式：3000、8081、8000、3307、8082
  - 生产模式：80、8080、8001、3306、8083

### LLM API Key 配置

系统支持以下大模型提供商（需在管理后台配置真实 API Key）：

| 提供商 | 支持模型 |
|-------|---------|
| DeepSeek | deepseek-chat |
| 智谱 AI | glm-4-flash、glm-4、embedding-2 |
| 通义千问 | qwen-turbo、qwen-plus、text-embedding-v2 |
| 豆包 | doubao-pro-32k |

---

## 三、启动方式

### 3.1 开发模式（Development）

开发模式支持热重载、Swagger 文档、详细日志输出，适合功能测试和调试。

```bash
# 1. 进入部署目录
cd deploy_soulmate

# 2. 初始化环境变量
# Windows:
copy env.dev.example .env.dev
# Linux/macOS:
cp env.dev.example .env.dev

# 3. 启动服务
# Windows:
docker compose -f docker-compose-dev.yml --env-file .env.dev up -d --build
# Linux/macOS:
make dev
```

**访问地址**

| 服务 | 地址 |
|-----|------|
| 前端页面 | http://localhost:3000 |
| 后端 API | http://localhost:8081 |
| Swagger 文档 | http://localhost:8081/swagger-ui.html |
| RAG 服务文档 | http://localhost:8000/docs |
| phpMyAdmin | http://localhost:8082（用户：root，密码：dev123456） |

### 3.2 生产模式（Production）

生产模式关闭调试功能，优化性能和安全性。

```bash
# 1. 进入部署目录
cd deploy_soulmate

# 2. 初始化环境变量
# Windows:
copy env.prod.example .env.prod
# Linux/macOS:
cp env.prod.example .env.prod
# ⚠️ 请编辑 .env.prod 修改 MYSQL_ROOT_PASSWORD 和 JWT_SECRET

# 3. 启动服务
# Windows:
docker compose -f docker-compose-prod.yml --env-file .env.prod up -d --build
# Linux/macOS:
make prod
```

**访问地址**

| 服务 | 地址 |
|-----|------|
| 前端页面 | http://localhost |
| 后端 API | http://localhost:8080 |
| RAG 服务 | http://localhost:8001 |
| phpMyAdmin | http://localhost:8083 |

### 3.3 停止服务

```bash
# Linux/macOS:
make stop-dev   # 停止开发环境
make stop-prod  # 停止生产环境

# Windows:
docker compose -f docker-compose-dev.yml --env-file .env.dev down
docker compose -f docker-compose-prod.yml --env-file .env.prod down
```

---

## 四、测试账号

系统预置以下测试账号，启动后即可使用：

| 角色 | 用户名 | 密码 | 权限说明 |
|-----|--------|------|---------|
| 超级管理员 | `superadmin` | `admin123` | 全部功能 + 用户管理 |
| 管理员 | `admin` | `admin123` | 智能体/知识库/工作流/模型/敏感词管理 |
| 普通用户 | `zhangsan_996` | `user123` | 对话、历史记录、个人中心 |

> **提示**：管理员账号 `admin` 和 `wangling`（密码均为 `admin123`）可用于测试管理功能。

---

## 五、功能模块说明

### 5.1 用户端功能

#### 5.1.1 首页（`/`）

- 平台介绍与服务特色展示
- 24/7 在线陪伴、隐私安全保护、专业心理支持等亮点
- 快速入口跳转智能体广场

#### 5.1.2 智能体广场（`/agents`）

- 卡片式展示已上架智能体（头像、名称、简介、标签、热度）
- 关键词搜索（支持名称、描述、标签，300ms 防抖）
- 排序方式：热度优先（默认）、最新发布
- 分页展示（12/24/48 条/页）
- 点击卡片直接开始对话

#### 5.1.3 对话功能（`/agents/:id`）

- **三栏布局**：左侧会话列表、中间消息区、右侧智能体信息
- **消息功能**：发送/接收消息、Markdown 渲染、知识库引用标识
- **会话管理**：新建会话、重命名、置顶、删除、清空消息
- **智能特性**：
  - 自动携带最近 10 条消息作为上下文
  - 首次对话后自动生成会话标题
  - RAG 知识库检索增强回复质量
  - 工作流执行（安全检测、危机干预）

#### 5.1.4 历史记录（`/history`）

- 网格布局展示所有会话
- 搜索过滤（按标题或智能体名称）
- 智能体筛选下拉
- 批量选择与删除
- 会话详情弹窗查看
- 分页（10/20/50/100 条/页）

#### 5.1.5 个人中心（`/profile`）

- 查看个人资料（头像、昵称、角色、注册时间）
- 修改昵称、个人简介
- 上传头像
- 修改密码（需验证原密码）

---

### 5.2 管理端功能

> 管理功能需使用 `admin` 或 `superadmin` 账号登录

#### 5.2.1 智能体管理（`/admin/agents`）

- 智能体列表（分页、筛选、排序）
- 创建智能体：配置名称、头像、描述、标签、人设提示词、开场白
- **详情编辑页三栏布局**：
  - 左栏：基本信息（名称、头像、简介、标签、系统提示词、问候语）
  - 中栏：资源配置（模型选择、知识库绑定、工作流关联、参数覆盖）
  - 右栏：测试对话与状态管理
- 支持上架/下架状态切换
- 测试对话功能验证智能体效果

#### 5.2.2 知识库管理（`/admin/knowledge-bases`）

- 知识库列表（显示文档数、切片数、启用状态）
- 创建知识库：配置名称、描述、嵌入模型
- **详情页功能**：
  - 文档上传（支持 TXT/MD 格式，最大 50MB）
  - 文档状态追踪（pending → processing → completed/failed）
  - 文档重试（失败时最多 3 次）
  - **检索测试**：输入查询返回 Top-K 相似片段及相似度分数
- 启用/禁用知识库（可选同时禁用关联智能体）

#### 5.2.3 工作流管理（`/admin/workflows`）

- 工作流列表（显示名称、节点数、状态）
- **可视化编辑器**（Vue Flow 拖拽式画布）：
  - 左侧节点工具箱（按分类展示、支持搜索）
  - 中间画布（拖拽、连线、网格对齐、缩放 20%-200%）
  - 右侧节点配置面板
  - 工具栏：撤销/重做（Ctrl+Z/Y）、自动布局、验证、保存发布
  - 小地图导航

**支持的节点类型**

| 节点 | 类型 | 功能 |
|-----|------|------|
| 开始 | `start` | 工作流入口，接收用户输入 |
| 文本处理 | `text_process` | 文本清洗与预处理 |
| 安全检测 | `safety_check` | 敏感词检测，分流 safe/crisis |
| 危机干预 | `crisis_intervention` | 推送心理援助热线 |
| 知识检索 | `rag_retrieval` | 向量相似度检索 |
| LLM 处理 | `llm_process` | 调用大模型生成回复 |
| 结束 | `end` | 工作流出口 |

#### 5.2.4 模型管理（`/admin/models`）

- **提供商管理**：
  - 配置名称、API 地址、API Key（AES 加密存储）
  - 启用/禁用提供商
- **模型管理**：
  - 关联提供商，配置模型名称、类型（chat/embedding）
  - 默认参数配置（temperature、max_tokens、top_p 等）
  - **对话测试**：验证模型 API 可用性
  - 查看关联智能体数量

#### 5.2.5 敏感词管理（`/admin/sensitive-words`）

- 敏感词列表（分页、按分类/动作/状态/关键词筛选）
- 创建/编辑敏感词

**分类与动作**

| 分类 | 说明 | 推荐动作 |
|-----|------|---------|
| `general` | 一般敏感词 | replace（替换）/ warn（警告） |
| `crisis` | 危机干预词 | intervention（干预） |
| `prohibited` | 绝对禁止词 | block（拦截） |

| 动作 | 说明 |
|-----|------|
| `block` | 直接拦截，返回提示 |
| `warn` | 记录警告，继续处理 |
| `replace` | 用替换文本替代 |
| `intervention` | 触发危机干预，推送心理援助热线（400-161-9995） |

- 批量操作：批量启用/禁用/删除

#### 5.2.6 用户管理（`/admin/users`）- 仅超级管理员

- 用户列表（分页、按角色/状态/关键词筛选）
- 创建用户（用户名、密码、昵称、角色）
- 编辑用户（修改昵称、角色）
- 启用/禁用用户账号
- 删除用户

---

### 5.3 预置数据

#### 内置智能体（8 个）

| 智能体 | 定位 | 关联工作流 | 关联知识库 |
|-------|------|-----------|-----------|
| 心声树洞 | 心理陪伴、情感倾诉 | 简单安全陪伴 | 心理学基础 |
| 情感解语 | 情感关系、恋爱困惑 | 情绪识别陪伴 | 情感关系 |
| 深夜心灯 | 失眠陪伴、夜间情绪 | 简单安全陪伴 | 睡眠与焦虑 |
| 职场加油站 | 职场压力、工作倦怠 | - | - |
| 正念小筑 | 正念冥想、呼吸练习 | - | - |
| 焦虑驿站 | 焦虑安抚、紧张缓解 | - | - |
| 自爱花园 | 自我关怀、自我接纳 | - | - |
| 心情日记本 | 情绪记录、情绪追踪 | - | - |

#### 内置知识库（5 个）

| 知识库 | 内容领域 |
|-------|---------|
| 心理学基础知识库 | 情绪管理、压力应对、心理健康基础 |
| 情绪识别知识库 | 情绪识别、情绪命名、情绪觉察 |
| 情感关系知识库 | 亲密关系、人际沟通、冲突处理 |
| 睡眠与焦虑知识库 | 失眠应对、焦虑缓解、放松技巧 |
| 职场心理知识库 | 职场压力管理、工作倦怠、职业发展 |

> **注意**：知识库需要上传文档后才能使用 RAG 检索功能。示例文档位于 `deploy_soulmate/database/示例文档/` 目录。

#### 内置工作流（2 个）

| 工作流 | 节点流程 |
|-------|---------|
| 简单安全陪伴 | 开始 → 安全检测 → [safe: LLM处理 / crisis: 危机干预] → 结束 |
| 情绪识别陪伴 | 开始 → 文本处理 → 安全检测 → [safe: LLM处理 / crisis: 危机干预] → 结束 |

---

## 六、核心技术实现

### 6.1 用户认证与权限

- JWT Token 认证（24 小时有效期）
- 密码 BCrypt 加密存储
- `@RequireRole` 自定义注解实现接口级鉴权
- 三级角色体系：User / Admin / SuperAdmin

### 6.2 RAG 知识检索

- 文档上传后自动切片（约 500 字/片，支持重叠）
- 异步向量化处理（支持重试机制）
- ChromaDB 向量数据库存储
- 基于余弦相似度的 Top-K 检索

### 6.3 工作流引擎

- 拓扑排序确定节点执行顺序
- 支持条件分支（安全检测节点分流 safe/crisis）
- 节点间数据流转（上下文传递）
- 可视化编辑与实时验证

### 6.4 安全风控

- 敏感词实时检测
- 危机干预机制（自动推送心理援助热线）
- API Key AES 加密存储

### 6.5 LLM 调用

- OpenAI 兼容接口，支持多厂商切换
- 可配置模型参数（temperature、max_tokens 等）
- 智能体级参数覆盖

---

## 七、项目结构概览

### 后端（Java）

| 模块 | 文件数 | 主要功能 |
|-----|--------|---------|
| 用户认证 | 12 | JWT 鉴权、角色权限、用户 CRUD |
| LLM 模型 | 10 | 提供商/模型管理、LLM 调用客户端 |
| 知识库 | 12 | 知识库 CRUD、文档处理、切片管理 |
| 工作流 | 15 | 工作流 CRUD、执行引擎、节点执行器 |
| 智能体 | 10 | 智能体 CRUD、资源绑定 |
| 对话 | 8 | 会话/消息管理、工作流执行集成 |
| 敏感词 | 6 | 敏感词 CRUD、检测服务 |
| 公共模块 | 10 | 统一响应、异常处理、工具类 |

### 前端（Vue）

| 模块 | 文件数 | 主要功能 |
|-----|--------|---------|
| 用户端页面 | 7 | 首页、广场、对话、历史、个人中心、登录注册 |
| 管理端页面 | 13 | 智能体/知识库/工作流/模型/敏感词/用户管理 |
| 工作流编辑器 | 8 | Vue Flow 画布、节点组件、工具栏 |
| API 封装 | 8 | 各模块 API 接口 |
| 状态管理 | 1 | Pinia 用户状态 |

### RAG 服务（Python）

| 模块 | 文件数 | 主要功能 |
|-----|--------|---------|
| API 路由 | 2 | 向量化、检索、集合管理接口 |
| 服务层 | 2 | 嵌入服务、检索服务 |
| 配置 | 2 | 数据库连接、环境配置 |

### 数据库

- 12 张数据表（用户、智能体、知识库、工作流、会话、消息等）
- 初始化脚本（表结构 + 预置数据）

### 部署配置

- Docker Compose 配置（开发/生产环境）
- Dockerfile（后端/前端/RAG 服务，各含开发/生产版本）
- 部署脚本与环境变量模板

---

## 八、快速验证流程

### 8.1 基础功能验证

1. 启动开发环境
2. 访问 http://localhost:3000，使用 `admin` / `admin123` 登录
3. 进入"模型管理"，为 DeepSeek 或智谱 AI 配置真实 API Key
4. 进入"智能体广场"，选择任一智能体开始对话
5. 验证消息发送、AI 回复、会话管理等功能

### 8.2 RAG 功能验证

1. 进入"知识库管理"，选择任一知识库
2. 上传 `deploy_soulmate/database/示例文档/` 中的 TXT 文件
3. 等待文档处理完成（状态变为 completed）
4. 使用"检索测试"功能验证向量检索
5. 与关联该知识库的智能体对话，观察知识库引用

### 8.3 工作流验证

1. 进入"工作流管理"，点击任一工作流的"编辑"按钮
2. 查看可视化工作流编辑器和节点配置
3. 与关联工作流的智能体对话
4. 输入危机词汇（如"不想活"），验证危机干预功能

### 8.4 敏感词验证

1. 进入"敏感词管理"，查看预置敏感词
2. 对话中输入危机词汇，验证干预消息
3. 添加测试敏感词，验证 block/replace 等动作

---

## 九、常见问题

### Q1: 服务启动失败

检查 Docker 是否正常运行，端口是否被占用：

```bash
docker ps
netstat -an | findstr "3000 8081 8000 3307"
```

### Q2: 对话无响应

1. 确认已配置有效的 LLM API Key（管理后台 → 模型管理）
2. 检查后端日志：`docker logs soulmate-dev-backend`
3. 确认智能体已关联有效的模型

### Q3: 知识库检索无结果

1. 确认文档处理状态为 completed
2. 检查 RAG 服务日志：`docker logs soulmate-dev-rag-service`
3. 确认知识库已绑定到智能体

### Q4: 查看服务日志

```bash
# 后端日志
docker logs -f soulmate-dev-backend

# RAG 服务日志
docker logs -f soulmate-dev-rag-service

# 前端日志
docker logs -f soulmate-dev-frontend
```

---

## 十、项目文档

| 文档 | 说明 |
|-----|------|
| `docs/01用户需求分析.md` | 完整功能需求说明 |
| `docs/02数据库设计.md` | 数据库表结构设计 |
| `docs/03API接口设计.md` | RESTful API 接口文档 |
| `docs/04开发指南.md` | 开发阶段与任务清单 |
| `deploy_soulmate/README.md` | 部署指南 |

---

**文档版本**：v1.0  
**最后更新**：2026-01-06

