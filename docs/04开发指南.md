# 📖 SoulMate 心伴 - 开发指南

> **SoulMate** - 您的AI心灵伴侣

## 📋 开发总览

### 技术栈

| 层级 | 技术 | 版本 |
|-----|------|-----|
| 前端 | Vue 3 + Vite + Element Plus + Tailwind CSS | Vue 3.5 / Vite 7 |
| 后端 | Spring Boot + Java + MyBatis + JWT | Spring Boot 3.2 / Java 17 |
| RAG服务 | Python + FastAPI + ChromaDB | Python 3.10+ |
| 数据库 | MySQL | 8.0 |
| 部署 | Docker + Docker Compose | - |

### 开发阶段总览

| 阶段 | 名称 | 核心目标 | 状态 |
|-----|------|---------|------|
| P1 | 项目初始化 | Docker + 数据库 + 项目骨架 | ✅ 已完成 |
| P2 | 用户认证 | 登录注册 + JWT鉴权 | ✅ 已完成 |
| P3 | LLM模型管理 | 提供商/模型CRUD + LLM调用 | ✅ 已完成 |
| P4 | 知识库管理 | 知识库CRUD + RAG服务 | ✅ 已完成 |
| P5 | 工作流管理 | 工作流CRUD + 执行引擎 | ✅ 已完成 |
| P6 | 智能体管理 | 智能体CRUD + 资源绑定 | ✅ 已完成 |
| P7 | 对话功能 | 会话/消息 + 工作流执行 | ✅ 已完成 |
| P8 | 安全风控 | 敏感词管理 + 危机干预 | ✅ 已完成 |
| P9 | 用户管理 | 用户CRUD + 个人中心 | ✅ 已完成 |
| P10 | 前端界面 | 用户端 + 管理端完整UI | ✅ 已完成 |
| P11 | 部署上线 | Docker部署 + 环境配置 | ✅ 已完成 |

---

## P1: 项目初始化与基础架构 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| 创建项目目录结构 | backend/frontend/rag_service/deploy_soulmate | ✅ |
| 初始化后端项目 | Spring Boot 3.2 + Java 17 + MyBatis | ✅ |
| 初始化前端项目 | Vue 3 + Vite + Element Plus | ✅ |
| 初始化RAG服务 | Python FastAPI + ChromaDB | ✅ |
| 配置Docker环境 | docker-compose-dev.yml / docker-compose-prod.yml | ✅ |
| 编写数据库脚本 | 01-schema.sql（12张表）+ 02-data.sql（初始数据） | ✅ |

### 目录结构

```
soulmate/
├── backend/                 # Spring Boot 后端
│   └── src/main/java/com/soulmate/
│       ├── common/         # 通用类（ApiResponse、异常、错误码）
│       ├── config/         # 配置类
│       ├── module/         # 业务模块
│       ├── security/       # 安全认证
│       └── util/           # 工具类
├── frontend/               # Vue 3 前端
│   └── src/
│       ├── api/           # API 接口封装
│       ├── views/         # 页面组件
│       └── stores/        # Pinia 状态管理
├── rag_service/           # Python RAG 服务
│   └── app/
│       ├── api/          # FastAPI 路由
│       └── services/     # 业务服务
├── deploy_soulmate/       # 部署配置
│   └── database/init/    # 数据库初始化脚本
└── docs/                  # 项目文档
```

### 核心依赖

**后端 (pom.xml)**
```xml
spring-boot-starter-parent: 3.2.0
java.version: 17
mybatis-spring-boot-starter: 3.0.3
jjwt: 0.11.5
```

**前端 (package.json)**
```json
vue: 3.5.18, vue-router: 4.5.1, pinia: 3.0.3
element-plus: 2.11.3, @vue-flow/core: 1.48.1
axios: 1.12.2, marked: 17.0.1
```

**RAG服务 (requirements.txt)**
```
fastapi>=0.104.0, uvicorn, chromadb>=0.4.15, openai>=1.3.0
```

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| Docker启动 | `docker-compose -f docker-compose-dev.yml up -d` 成功 | ✅ |
| 数据库初始化 | 12张表创建成功，初始数据导入 | ✅ |
| 后端健康检查 | `GET /api/ping` 返回 `pong` | ✅ |
| 前端启动 | `npm run dev` 后访问 localhost:3000 | ✅ |
| RAG服务 | `GET /api/rag/health` 返回健康状态 | ✅ |

---

## P2: 用户认证与权限系统 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| JWT工具类 | Token生成/验证，24小时有效期 | ✅ |
| 用户注册接口 | 用户名+密码+昵称，自动返回Token | ✅ |
| 用户登录接口 | 返回JWT Token和用户信息 | ✅ |
| 权限注解 | `@RequireRole` 自定义注解实现接口级鉴权 | ✅ |
| JWT过滤器 | 拦截请求验证Token有效性 | ✅ |
| 前端登录页 | 登录/注册表单 | ✅ |
| 路由守卫 | 前端自动校验登录状态和角色权限 | ✅ |
| 状态管理 | Pinia存储用户信息，支持持久化 | ✅ |

### API接口

| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/auth/register` | POST | 用户注册（返回Token） |
| `/api/v1/auth/login` | POST | 用户登录 |
| `/api/v1/auth/me` | GET | 获取当前用户信息 |
| `/api/v1/auth/logout` | POST | 用户登出 |

### 技术要点

```java
// 密码加密：BCrypt
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
String encoded = encoder.encode(rawPassword);

// 权限控制：自定义注解
@RequireRole({"admin", "superadmin"})
public void adminMethod() { ... }
```

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 注册功能 | 注册成功返回Token，密码BCrypt加密存储 | ✅ |
| 登录功能 | 登录成功返回Token和用户信息 | ✅ |
| Token验证 | 过期/无效Token返回401错误 | ✅ |
| 权限控制 | 普通用户无法访问管理员接口（403） | ✅ |
| 状态持久化 | 刷新页面登录状态不丢失 | ✅ |

**实现位置**：`backend/src/main/java/com/soulmate/module/auth/`

---

## P3: LLM模型管理 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| 提供商CRUD | 创建/编辑/删除LLM提供商 | ✅ |
| 模型CRUD | 创建/编辑/删除LLM模型 | ✅ |
| API Key加密 | AES加密存储，界面不显示明文 | ✅ |
| LLM调用客户端 | OpenAI兼容接口，支持多厂商 | ✅ |
| 模型测试 | 输入测试消息验证模型可用性 | ✅ |
| 前端管理页 | 提供商/模型管理界面 | ✅ |

### API接口

**提供商管理**
| API | 方法 | 权限 | 说明 |
|-----|------|------|------|
| `/api/v1/llm/providers` | GET | Admin | 提供商列表 |
| `/api/v1/llm/providers` | POST | Admin | 创建提供商 |
| `/api/v1/llm/providers/{id}` | PUT | Admin | 更新提供商 |
| `/api/v1/llm/providers/{id}` | DELETE | Admin | 删除提供商 |

**模型管理**
| API | 方法 | 权限 | 说明 |
|-----|------|------|------|
| `/api/v1/llm/models` | GET | Admin | 模型列表 |
| `/api/v1/llm/models` | POST | Admin | 创建模型 |
| `/api/v1/llm/models/{id}` | PUT | Admin | 更新模型 |
| `/api/v1/llm/models/{id}` | DELETE | Admin | 删除模型 |
| `/api/v1/llm/models/test-chat` | POST | Admin | 测试对话 |

### 支持的LLM提供商

| 提供商 | API地址 | 模型示例 |
|-------|--------|---------|
| DeepSeek | https://api.deepseek.com/v1 | deepseek-chat |
| 智谱AI | https://open.bigmodel.cn/api/paas/v4 | glm-4-flash, glm-4 |
| 通义千问 | https://dashscope.aliyuncs.com/compatible-mode/v1 | qwen-turbo, qwen-plus |
| 豆包 | https://ark.cn-beijing.volces.com/api/v3 | doubao-pro-32k |

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 提供商CRUD | 可创建、编辑、删除提供商 | ✅ |
| API Key安全 | 数据库加密存储，界面显示*** | ✅ |
| 模型CRUD | 可创建、编辑、删除模型 | ✅ |
| 测试对话 | 输入"你好"返回正常回复 | ✅ |
| 关联检查 | 删除提供商时检查关联模型 | ✅ |

**实现位置**：`backend/src/main/java/com/soulmate/module/llm/`

---

## P4: 知识库与RAG服务 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| 知识库CRUD | 创建/编辑/删除知识库 | ✅ |
| 文档上传 | 支持TXT/MD格式，最大50MB | ✅ |
| 文档切片 | 按句子切分，约500字/片，支持重叠 | ✅ |
| RAG向量化 | 调用嵌入模型生成向量 | ✅ |
| ChromaDB存储 | 向量数据持久化存储 | ✅ |
| 异步处理 | 文档上传后异步切片和向量化 | ✅ |
| 检索测试 | 输入查询返回Top-K相似片段 | ✅ |
| 前端管理页 | 知识库管理 + 文档上传 + 检索测试 | ✅ |

### 后端API

| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/knowledge-bases` | GET/POST | 知识库列表/创建 |
| `/api/v1/knowledge-bases/{id}` | GET/PUT/DELETE | 详情/更新/删除 |
| `/api/v1/knowledge-bases/{id}/documents` | GET/POST | 文档列表/上传 |
| `/api/v1/knowledge-bases/{id}/documents/{docId}` | DELETE | 删除文档 |
| `/api/v1/knowledge-bases/{id}/documents/{docId}/status` | GET | 查询处理状态 |
| `/api/v1/knowledge-bases/{id}/documents/{docId}/retry` | POST | 重试处理 |
| `/api/v1/knowledge-bases/{id}/test` | POST | 检索测试 |

### RAG服务API（Python FastAPI）

| API | 方法 | 说明 |
|-----|------|------|
| `/api/rag/embed` | POST | 文本向量化 |
| `/api/rag/index` | POST | 索引文档切片 |
| `/api/rag/search` | POST | 向量检索 |
| `/api/rag/collection/{kb_id}` | DELETE | 删除知识库向量 |
| `/api/rag/document/{kb_id}/{doc_id}` | DELETE | 删除文档向量 |
| `/api/rag/health` | GET | 健康检查 |

### 文档处理流程

```
文档上传 → pending → processing → completed/failed
              ↓
    异步任务：读取文件 → 文本切片 → 向量化 → 存入ChromaDB → 更新状态
```

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 知识库CRUD | 可创建、编辑、删除知识库 | ✅ |
| 文档上传 | 上传TXT/MD文件成功 | ✅ |
| 异步处理 | 状态从pending→processing→completed | ✅ |
| 切片存储 | MySQL切片记录 + ChromaDB向量数据 | ✅ |
| 检索测试 | 返回相关片段及相似度分数 | ✅ |
| 删除同步 | 删除知识库时同步删除向量数据 | ✅ |

**实现位置**：
- 后端：`backend/src/main/java/com/soulmate/module/knowledge/`
- RAG服务：`rag_service/app/`

---

## P5: 工作流引擎 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| 工作流CRUD | 创建/编辑/删除/启用/禁用 | ✅ |
| 节点类型设计 | 7种节点（start/text_process/safety_check/crisis_intervention/rag_retrieval/llm_process/end） | ✅ |
| 执行引擎 | 拓扑排序 + 按序执行节点 | ✅ |
| 节点执行器 | 各节点类型的具体实现 | ✅ |
| 前端编辑器 | Vue Flow拖拽式可视化编辑 | ✅ |
| 工作流验证 | 验证节点连接和配置完整性 | ✅ |

### API接口

| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/workflows` | GET/POST | 工作流列表/创建 |
| `/api/v1/workflows/{id}` | GET/PUT/DELETE | 详情/更新/删除 |
| `/api/v1/workflows/{id}/status` | PUT | 启用/禁用 |
| `/api/v1/workflows/node-definitions` | GET | 获取节点定义 |
| `/api/v1/workflows/validate` | POST | 验证工作流配置 |

### 节点类型

| 节点 | 类型 | 功能 | 输出端口 |
|-----|------|------|---------|
| 开始 | `start` | 接收用户输入 | output |
| 文本处理 | `text_process` | 文本清洗与预处理 | output |
| 安全检测 | `safety_check` | 敏感词检测 | safe, crisis |
| 危机干预 | `crisis_intervention` | 推送援助热线 | output |
| 知识检索 | `rag_retrieval` | 向量相似度检索 | output |
| LLM处理 | `llm_process` | 调用大模型生成回复 | output |
| 结束 | `end` | 输出最终回复 | - |

### 执行引擎实现

```java
// WorkflowEngine.java
public WorkflowResult execute(String workflowId, WorkflowContext context) {
    // 1. 加载工作流配置
    // 2. 初始化上下文
    // 3. 拓扑排序节点
    // 4. 依次执行节点
    // 5. 返回最终结果
}
```

### 前端编辑器功能

| 功能 | 说明 |
|-----|------|
| 节点工具箱 | 左侧分类展示可拖拽节点 |
| 画布操作 | 拖拽、缩放、平移、网格对齐 |
| 节点连线 | 端口连接、自动验证 |
| 节点配置 | 右侧面板配置节点参数 |
| 工具栏 | 撤销/重做、自动布局、验证、保存 |
| 小地图 | 右下角缩略图导航 |

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 工作流CRUD | 可创建、编辑、删除工作流 | ✅ |
| 可视化编辑 | 节点拖拽、连线正常工作 | ✅ |
| 节点配置 | 配置面板可编辑节点参数 | ✅ |
| 工作流验证 | 检测配置错误并提示 | ✅ |
| 执行引擎 | 按拓扑顺序执行各节点 | ✅ |
| 安全检测 | 正确分流到safe/crisis | ✅ |
| RAG检索 | 返回相关知识库内容 | ✅ |
| LLM处理 | 调用模型生成回复 | ✅ |

**实现位置**：
- 后端：`backend/src/main/java/com/soulmate/module/workflow/`
- 前端：`frontend/src/views/admin/workflow/`

---

## P6: 智能体管理 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| 智能体CRUD | 创建/编辑/删除智能体 | ✅ |
| 知识库绑定 | 多对多关联，批量绑定/解绑 | ✅ |
| 工作流关联 | 一对一关联（可为空） | ✅ |
| 模型参数覆盖 | temperature/max_tokens等参数配置 | ✅ |
| 状态管理 | published（上架）/ offline（下架） | ✅ |
| 热度统计 | 创建会话时heat_value += 1 | ✅ |
| 测试对话 | 管理端测试智能体效果 | ✅ |
| 前端管理页 | 智能体列表 + 详情编辑 | ✅ |

### API接口

| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/agents` | GET | 智能体列表（广场公开） |
| `/api/v1/agents` | POST | 创建智能体（Admin） |
| `/api/v1/agents/{id}` | GET/PUT/DELETE | 详情/更新/删除 |
| `/api/v1/agents/{id}/status` | PUT | 上架/下架 |
| `/api/v1/agents/{id}/knowledge` | GET/POST | 获取/绑定知识库 |
| `/api/v1/agents/{id}/knowledge/{kbId}` | DELETE | 解绑知识库 |

### 智能体配置结构

```json
{
  "name": "心声树洞",
  "avatar": "https://...",
  "description": "...",
  "tags": "倾诉,陪伴,情感",
  "greeting": "嗨，欢迎来到心声树洞...",
  "systemPrompt": "你是一位温暖的心理陪伴师...",
  "modelId": "mdl_deepseek_chat",
  "modelConfig": { "temperature": 0.8, "max_tokens": 1500 },
  "workflowId": "wfl_simple_safe",
  "kbIds": ["kb_psychology"]
}
```

### 初始化智能体（8个）

| 智能体 | 定位 | 工作流 | 知识库 |
|-------|------|--------|--------|
| 心声树洞 | 心理陪伴 | 简单安全陪伴 | 心理学基础 |
| 情感解语 | 情感倾诉 | 情绪识别陪伴 | 情感关系 |
| 深夜心灯 | 失眠陪伴 | 简单安全陪伴 | 睡眠与焦虑 |
| 职场加油站 | 职场解压 | 情绪识别陪伴 | 职场心理 |
| 正念小筑 | 正念冥想 | 简单安全陪伴 | 心理学基础 |
| 焦虑驿站 | 焦虑安抚 | 情绪识别陪伴 | 睡眠与焦虑 |
| 自爱花园 | 自我关怀 | 简单安全陪伴 | 情绪识别 |
| 心情日记本 | 情绪记录 | 情绪识别陪伴 | 情绪识别 |

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 智能体CRUD | 可创建、编辑、删除智能体 | ✅ |
| 知识库绑定 | 可绑定/解绑多个知识库 | ✅ |
| 工作流关联 | 可关联/取消关联工作流 | ✅ |
| 状态切换 | 上架后在广场展示，下架后隐藏 | ✅ |
| 测试对话 | 管理端测试对话正常 | ✅ |
| 初始数据 | 8个智能体配置完成 | ✅ |

**实现位置**：`backend/src/main/java/com/soulmate/module/agent/`

---

## P7: 对话功能 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| 会话CRUD | 创建/删除会话，修改标题/置顶 | ✅ |
| 消息发送 | 用户发送消息，获取AI回复 | ✅ |
| 历史消息 | 分页加载历史消息（每页50条） | ✅ |
| 工作流执行 | 关联工作流时执行工作流 | ✅ |
| RAG检索 | 关联知识库时自动检索 | ✅ |
| 标题生成 | 首次对话后自动生成会话标题 | ✅ |
| 知识库引用 | 显示回复中引用的知识库 | ✅ |
| Markdown渲染 | 消息内容支持Markdown | ✅ |
| 前端对话页 | 三栏布局（会话列表/消息区/智能体信息） | ✅ |

### API接口

**会话管理**
| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/sessions` | GET/POST | 会话列表/创建 |
| `/api/v1/sessions/{id}` | GET/DELETE | 会话详情/删除 |
| `/api/v1/sessions/{id}/title` | PUT | 修改标题 |
| `/api/v1/sessions/{id}/pin` | PUT | 置顶/取消置顶 |

**消息管理**
| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/sessions/{id}/messages` | GET | 消息列表（分页） |
| `/api/v1/sessions/{id}/messages` | POST | 发送消息 |

### 对话流程

```
用户发送消息
    ↓
创建用户消息记录
    ↓
检查智能体是否关联工作流
    ├─ 是 → 执行工作流
    │       ├─ start → 安全检测 → [crisis/safe]
    │       │                      ├─ crisis → 危机干预 → end
    │       │                      └─ safe → RAG检索 → LLM生成 → end
    │       └─ 返回执行结果
    └─ 否 → RAG检索（Agent层知识库）→ 直接调用LLM
    ↓
保存助手消息记录
    ↓
更新会话信息（消息数、标题）
    ↓
返回响应（含知识库引用）
```

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 创建会话 | 创建成功，展示开场白 | ✅ |
| 发送消息 | 发送后获得AI回复 | ✅ |
| 历史消息 | 分页加载历史消息 | ✅ |
| Markdown | 消息支持Markdown渲染 | ✅ |
| 自动标题 | 首次对话后自动生成标题 | ✅ |
| 会话置顶 | 置顶会话排在最前 | ✅ |
| 知识库引用 | 正确显示引用的知识库 | ✅ |
| 工作流执行 | 关联工作流时正确执行 | ✅ |

**实现位置**：`backend/src/main/java/com/soulmate/module/chat/`

---

## P8: 敏感词与安全风控 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| 敏感词CRUD | 创建/编辑/删除敏感词 | ✅ |
| 分类管理 | general/crisis/prohibited三类 | ✅ |
| 动作处理 | block/warn/replace/intervention | ✅ |
| 危机干预 | 检测到危机词汇推送援助热线 | ✅ |
| 批量操作 | 批量启用/禁用/删除 | ✅ |
| 前端管理页 | 敏感词列表 + 筛选 + 批量操作 | ✅ |

### API接口

| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/sensitive-words` | GET/POST | 敏感词列表/创建 |
| `/api/v1/sensitive-words/{id}` | PUT/DELETE | 更新/删除 |
| `/api/v1/sensitive-words/{id}/status` | PUT | 启用/禁用 |
| `/api/v1/sensitive-words/batch/status` | PUT | 批量更新状态 |
| `/api/v1/sensitive-words/batch` | DELETE | 批量删除 |

### 敏感词分类与动作

| 分类 | 说明 | 推荐动作 |
|-----|------|---------|
| `general` | 一般敏感词（脏话等） | replace/warn |
| `crisis` | 危机干预词（轻生相关） | intervention |
| `prohibited` | 绝对禁止词 | block |

| 动作 | 说明 |
|-----|------|
| `block` | 直接拦截，返回提示 |
| `warn` | 记录警告，继续处理 |
| `replace` | 用替换文本替代 |
| `intervention` | 触发危机干预，推送援助热线 |

### 危机干预消息

```
我注意到您可能正在经历一些困难的时刻。
请记住，您并不孤单，专业的帮助随时可以获得。
如果您需要专业支持，可以拨打心理援助热线：400-161-9995
```

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 敏感词CRUD | 可创建、编辑、删除敏感词 | ✅ |
| block动作 | 输入禁止词被拦截 | ✅ |
| replace动作 | 敏感词被替换为*** | ✅ |
| intervention | 危机词汇触发干预消息 | ✅ |
| 批量操作 | 批量启用/禁用/删除正常 | ✅ |

**实现位置**：`backend/src/main/java/com/soulmate/module/sensitive/`

---

## P9: 用户中心与管理 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| 个人信息查看 | 获取当前用户详细信息 | ✅ |
| 个人信息修改 | 修改昵称、简介 | ✅ |
| 密码修改 | 验证原密码后修改 | ✅ |
| 头像上传 | 上传图片设置头像 | ✅ |
| 用户列表 | SuperAdmin查看所有用户 | ✅ |
| 用户管理 | 修改角色、启用/禁用、删除 | ✅ |
| 前端页面 | 个人中心 + 用户管理 | ✅ |

### API接口

**个人中心**
| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/profile` | GET | 获取个人信息 |
| `/api/v1/profile` | PUT | 更新个人信息 |
| `/api/v1/profile/password` | PUT | 修改密码 |
| `/api/v1/profile/avatar` | POST | 上传头像 |

**用户管理（SuperAdmin）**
| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/users` | GET | 用户列表 |
| `/api/v1/users/{id}` | GET/PUT/DELETE | 详情/更新/删除 |
| `/api/v1/users/{id}/status` | PUT | 启用/禁用 |

### 角色权限

| 角色 | 权限范围 |
|-----|---------|
| `user` | 对话、个人中心 |
| `admin` | 智能体/知识库/工作流/模型/敏感词管理 |
| `superadmin` | Admin权限 + 用户管理 |

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 查看信息 | 个人中心显示完整信息 | ✅ |
| 修改信息 | 可修改昵称、简介 | ✅ |
| 修改密码 | 验证原密码后修改成功 | ✅ |
| 上传头像 | 头像上传并显示 | ✅ |
| 用户列表 | SuperAdmin可查看用户列表 | ✅ |
| 角色修改 | SuperAdmin可修改用户角色 | ✅ |
| 权限控制 | Admin无法访问用户管理 | ✅ |

**实现位置**：`backend/src/main/java/com/soulmate/module/user/`

---

## P10: 前端用户界面 ✅

### 页面清单

**公共页面**
| 路由 | 页面 | 状态 |
|-----|------|------|
| `/login` | 登录页 | ✅ |
| `/register` | 注册页 | ✅ |

**用户端**
| 路由 | 页面 | 状态 |
|-----|------|------|
| `/` | 首页（平台介绍） | ✅ |
| `/agents` | 智能体广场 | ✅ |
| `/agents/:id` | 对话页面 | ✅ |
| `/history` | 历史记录 | ✅ |
| `/profile` | 个人中心 | ✅ |

**管理端**
| 路由 | 页面 | 状态 |
|-----|------|------|
| `/admin/agents` | 智能体管理 | ✅ |
| `/admin/agents/:id` | 智能体详情编辑 | ✅ |
| `/admin/knowledge-bases` | 知识库管理 | ✅ |
| `/admin/knowledge-bases/:id` | 知识库详情 | ✅ |
| `/admin/workflows` | 工作流管理 | ✅ |
| `/admin/workflows/:id/edit` | 工作流编辑器 | ✅ |
| `/admin/models` | 模型管理 | ✅ |
| `/admin/sensitive-words` | 敏感词管理 | ✅ |
| `/admin/users` | 用户管理（SuperAdmin） | ✅ |

### 核心功能

**智能体广场**
- 卡片展示（头像、名称、简介、标签、热度）
- 关键词搜索（300ms防抖）
- 排序（热度优先、最新发布）
- 分页（12/24/48条）

**对话页面**
- 左侧栏：会话列表、新建会话、会话操作
- 中间区：消息列表、输入框、发送按钮
- 右侧栏：智能体信息、开场白

**工作流编辑器**
- Vue Flow拖拽式画布
- 节点工具箱
- 节点配置面板
- 撤销/重做、自动布局

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 首页 | 展示平台介绍和服务特色 | ✅ |
| 智能体广场 | 正确展示已上架智能体 | ✅ |
| 搜索排序 | 搜索、排序、分页功能正常 | ✅ |
| 对话页面 | 三栏布局，消息收发正常 | ✅ |
| 会话管理 | 新建、重命名、删除、置顶 | ✅ |
| 历史记录 | 筛选、批量操作功能正常 | ✅ |
| 管理后台 | 所有管理页面功能完整 | ✅ |
| 响应式 | 移动端适配正常 | ✅ |

**实现位置**：`frontend/src/views/`

---

## P11: 部署与上线 ✅

### 任务清单

| 任务 | 说明 | 状态 |
|-----|------|------|
| 开发环境Dockerfile | 后端/前端/RAG服务 | ✅ |
| 生产环境Dockerfile | 优化镜像体积 | ✅ |
| 开发环境compose | docker-compose-dev.yml | ✅ |
| 生产环境compose | docker-compose-prod.yml | ✅ |
| 部署脚本 | deploy.dev.sh / deploy.prod.sh | ✅ |
| Nginx配置 | 反向代理 + 静态资源 | ✅ |
| 环境变量 | .env配置模板 | ✅ |

### 服务端口

| 服务 | 开发端口 | 生产端口 |
|-----|---------|---------|
| 前端 | 3000 | 80 |
| 后端 | 8081 | 8081 |
| RAG服务 | 8000 | 8000 |
| MySQL | 3307 | 3306 |
| phpMyAdmin | 8082 | - |

### 部署命令

**开发环境**
```bash
cd deploy_soulmate
cp env.dev.example .env
docker-compose -f docker-compose-dev.yml up -d
```

**生产环境**
```bash
cd deploy_soulmate
cp env.prod.example .env
# 编辑.env配置真实密钥
docker-compose -f docker-compose-prod.yml up -d
```

### 关键环境变量

| 变量 | 说明 |
|-----|------|
| `MYSQL_ROOT_PASSWORD` | MySQL密码 |
| `JWT_SECRET` | JWT签名密钥（32位以上） |
| `ENCRYPTION_KEY` | AES加密密钥（16位） |

### 验收方式

| 检查项 | 验证方式 | 状态 |
|-------|---------|------|
| 开发环境 | 一键启动所有服务 | ✅ |
| 生产环境 | 一键部署成功 | ✅ |
| 数据库 | 自动初始化表结构和数据 | ✅ |
| 健康检查 | 各服务健康检查通过 | ✅ |
| 日志输出 | 日志正确输出到文件/控制台 | ✅ |
| 数据持久化 | 重启后数据不丢失 | ✅ |

**实现位置**：`deploy_soulmate/`

---

## 📋 附录

### 错误码表

| 错误码 | 说明 |
|-------|------|
| 0 | 成功 |
| 1001 | 请求参数错误 |
| 1002 | 系统错误 |
| 2001 | 未授权 |
| 2003 | 权限不足 |
| 3001 | 用户不存在 |
| 3002 | 用户名已存在 |
| 3003 | 密码错误 |
| 4001 | 智能体不存在 |
| 5001 | 知识库不存在 |
| 6001 | 工作流不存在 |
| 7001 | 会话不存在 |
| 8001-8003 | LLM相关错误 |

### 测试账号

| 角色 | 用户名 | 密码 |
|-----|-------|------|
| 超级管理员 | superadmin | superadmin123 |
| 管理员 | admin | admin123 |
| 普通用户 | zhangsan_996 | user123 |

### 快速启动

```bash
# 1. 启动数据库
cd deploy_soulmate
docker-compose -f docker-compose-dev.yml up -d mysql

# 2. 启动后端
cd backend
./mvnw spring-boot:run -Dspring.profiles.active=dev

# 3. 启动RAG服务
cd rag_service
venv\Scripts\activate  # Windows
uvicorn app.main:app --reload --port 8000

# 4. 启动前端
cd frontend
npm run dev
```

### 技术参考

| 资源 | 链接 |
|-----|------|
| Vue 3 | https://vuejs.org/ |
| Element Plus | https://element-plus.org/ |
| Vue Flow | https://vueflow.dev/ |
| Spring Boot | https://spring.io/projects/spring-boot |
| FastAPI | https://fastapi.tiangolo.com/ |
| ChromaDB | https://www.trychroma.com/ |

---

**文档版本**：v1.0  
**最后更新**：2026-01-02
