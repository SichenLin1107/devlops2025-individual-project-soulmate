# 📋 SoulMate 心伴 - 用户需求分析

> **SoulMate** - 您的AI心灵伴侣 

## 1. 项目概述

SoulMate 是一个**心理陪伴智能体开发与使用平台**，面向心灵陪伴场景，提供智能体创建、知识库管理、工作流编排等能力。平台内置8类专业心理陪伴智能体，涵盖情感倾听、职场解压、失眠陪伴、焦虑安抚、正念冥想、自我关怀、情绪记录等场景，帮助用户获得专业、温暖的心理支持。

### 1.1 平台定位

| 角色 | 核心能力 |
|-----|---------|
| **普通用户** | 选择智能体对话、管理会话记录、修改个人信息 |
| **管理员** | 智能体管理、知识库管理、工作流编排、模型配置、敏感词管理 |
| **超级管理员** | 在管理员基础上增加用户管理权限 |

### 1.2 智能体类型

平台提供8类心理陪伴智能体：

- **心声树洞**：心理陪伴、情感倾诉、情绪支持
- **情感解语**：情感关系、恋爱困惑、人际沟通
- **深夜心灯**：失眠陪伴、夜间情绪、睡前放松
- **职场加油站**：职场压力、工作倦怠、职业发展
- **正念小筑**：正念冥想、呼吸练习、情绪觉察
- **焦虑驿站**：焦虑安抚、紧张缓解、放松技巧
- **自爱花园**：自我关怀、自我接纳、边界建立
- **心情日记本**：情绪记录、情绪识别、情绪追踪

### 1.3 知识库体系

平台内置5个专业知识库：

- **心理学基础知识库**：情绪管理、压力应对、心理健康基础
- **情绪识别知识库**：情绪识别、情绪命名、情绪觉察
- **情感关系知识库**：亲密关系、人际沟通、冲突处理
- **睡眠与焦虑知识库**：失眠应对、焦虑缓解、放松技巧
- **职场心理知识库**：职场压力管理、工作倦怠、职业发展

### 1.4 系统架构

```
前端 Vue 3 + 业务后端 Spring Boot + RAG服务 Python FastAPI
```

---

## 2. 核心使用场景

| 场景 | 描述 |
|-----|------|
| **S1 用户对话** | 用户选择智能体 → 开始对话 → 查看历史记录 |
| **S2 个人中心** | 修改昵称、头像、密码等个人信息 |
| **S3 模型管理** | 管理员配置 LLM 提供商和模型（API地址、Key、默认参数） |
| **S4 知识库管理** | 创建知识库 → 上传文档 → 自动切片向量化 → 检索测试 |
| **S5 工作流编排** | 拖拽式编排节点（安全检测、知识检索、LLM处理等） |
| **S6 智能体配置** | 配置人设、开场白、关联模型/知识库/工作流 → 上架 |
| **S7 安全风控** | 敏感词检测、危机干预（推送心理援助热线） |

---

## 3. 功能模块

### 3.1 用户认证与权限

| 功能 | 说明 |
|-----|------|
| 注册 | 用户名+密码+昵称，注册成功自动返回Token |
| 登录 | 返回JWT Token和用户信息 |
| 获取当前用户 | 获取当前登录用户信息 |
| 登出 | 清除Token |
| 角色权限 | User（普通用户）、Admin（管理员）、SuperAdmin（超级管理员） |
| 接口鉴权 | 使用 `@RequireRole` 注解，自动校验用户角色权限 |

### 3.2 菜单与路由

| 角色 | 菜单 | 路由 |
|-----|------|------|
| User | 首页 | `/` |
| User | 智能体广场 | `/agents` |
| User | 对话页面 | `/agents/:id` |
| User | 历史记录 | `/history` |
| User | 个人中心 | `/profile` |
| Admin | 智能体管理 | `/admin/agents` |
| Admin | 知识库管理 | `/admin/knowledge-bases` |
| Admin | 工作流管理 | `/admin/workflows` |
| Admin | 工作流编辑器 | `/admin/workflows/:id/edit` |
| Admin | 模型管理 | `/admin/models` |
| Admin | 敏感词管理 | `/admin/sensitive-words` |
| SuperAdmin | 用户管理 | `/admin/users` |

### 3.3 首页（`/`）

| 功能 | 说明 |
|-----|------|
| 欢迎区域 | 展示平台名称、标语、服务介绍 |
| 服务特色 | 展示24/7在线陪伴、隐私安全保护、个性化智能体、专业心理支持等特色 |
| 快速入口 | 提供"开始心理陪伴"按钮，跳转到智能体广场 |
| 免责声明 | 提示平台提供情绪陪伴服务，不替代专业心理咨询 |

### 3.4 智能体广场（`/agents`）

| 功能 | 说明 |
|-----|------|
| 卡片展示 | 头像、名称、简介、标签、热度徽章 |
| 搜索 | 支持按名称、描述、标签关键词搜索，300ms防抖 |
| 排序 | 热度优先（默认）、最新发布 |
| 分页 | 每页12/24/48条，支持页码跳转 |
| 开始对话 | 点击卡片或"开始对话"按钮 → 自动创建会话 → 跳转对话页 |

### 3.5 对话功能（`/agents/:id`）

| 功能 | 说明 |
|-----|------|
| 发送消息 | HTTP请求-响应模式，支持工作流执行和直接LLM调用 |
| 消息记录 | 分页加载历史消息（每页50条），支持Markdown渲染 |
| 上下文 | 自动携带最近10条消息作为LLM上下文 |
| RAG检索 | 智能体关联的知识库自动检索，检索结果作为上下文 |
| 会话列表 | 左侧边栏展示当前智能体的会话列表，支持分页 |
| 新建会话 | 创建新会话，默认标题"新对话" |
| 重命名 | 双击或点击编辑按钮修改会话标题 |
| 删除 | 删除会话及其所有消息 |
| 置顶 | 置顶/取消置顶会话，置顶会话排在最前 |
| 智能体信息 | 右侧边栏展示智能体头像、名称、描述、开场白 |
| 知识库引用 | 显示回复中引用的知识库名称 |
| 清空对话 | 清空当前会话的所有消息 |
| 自动标题 | 首次对话后自动根据用户输入生成会话标题 |

### 3.6 历史记录（`/history`）

| 功能 | 说明 |
|-----|------|
| 会话列表 | 网格布局展示所有会话，显示智能体头像、会话标题、消息数、更新时间 |
| 搜索 | 支持按会话标题或智能体名称搜索，实时过滤 |
| 智能体筛选 | 下拉选择筛选特定智能体的会话 |
| 批量选择 | 支持多选会话，显示选中数量 |
| 批量删除 | 批量删除选中的会话及其所有消息 |
| 置顶标识 | 显示置顶会话的置顶标签 |
| 会话查看 | 点击会话卡片或"查看"按钮，弹窗显示会话详情（消息列表） |
| 跳转智能体 | 在会话详情弹窗中可跳转到对应智能体的对话页面 |
| 分页 | 支持分页加载（每页10/20/50/100条），显示总记录数 |
| 刷新 | 手动刷新会话列表 |

### 3.7 管理功能

#### 3.7.1 智能体管理（Admin+）

| 功能 | 说明 |
|-----|------|
| 列表 | 分页展示，支持按状态/标签/关键词筛选，按热度/创建时间排序 |
| 创建 | 名称、描述、头像URL、标签、人设提示词、开场白 |
| 详情编辑 | 三栏布局：左侧（名称、头像、简介、标签、系统提示词、问候语）、中间（模型配置、知识库绑定、工作流关联、模型参数覆盖）、右侧（测试对话、状态管理） |
| 头像上传 | 支持上传图片设置智能体头像 |
| 标签管理 | 支持多选标签，可自定义创建新标签 |
| 模型配置 | 选择对话模型，支持查看模型提供商信息 |
| 知识库绑定 | 多选知识库，支持查看知识库描述，批量绑定/解绑 |
| 工作流关联 | 可选关联工作流，支持查看工作流信息 |
| 模型参数覆盖 | 可配置temperature、max_tokens等参数覆盖默认值 |
| 状态管理 | published（已发布）/ offline（已下架），支持上架/下架操作 |
| 测试对话 | 右侧栏提供测试对话功能，可创建测试会话、查看历史记录、清屏 |
| 删除 | 软删除，同时删除关联的会话和消息 |

#### 3.7.2 知识库管理（Admin+）

| 功能 | 说明 |
|-----|------|
| 列表 | 分页展示，显示文档数、切片数、启用状态 |
| 创建 | 名称、描述、嵌入模型配置 |
| 详情页面 | 左侧显示知识库信息（名称、描述、文档数、切片数、向量模型、创建者、创建时间），右侧显示文档列表和检索测试 |
| 文档列表 | 表格展示文档信息（文件名、类型、大小、处理状态、切片数、上传时间） |
| 文档状态筛选 | 支持按pending/processing/completed/failed筛选文档 |
| 文档上传 | 支持TXT/MD格式，上传后异步处理（切片→向量化） |
| 文档状态 | pending/processing/completed/failed，失败可重试 |
| 文档状态查询 | 支持查询单个文档的处理状态，用于轮询处理进度 |
| 文档重试 | 失败状态的文档支持重试处理（最多3次） |
| 文档删除 | 删除单个文档及其向量数据 |
| 检索测试 | 输入查询语句，返回Top-K相似文档及相似度分数，显示文档片段内容 |
| 启用/禁用 | 禁用时可选同时禁用关联智能体，显示关联智能体数量 |
| 删除 | 删除知识库及ChromaDB中的向量数据 |

#### 3.7.3 工作流管理（Admin+）

| 功能 | 说明 |
|-----|------|
| 列表 | 分页展示，显示名称、节点数、启用状态 |
| 编辑器 | Vue Flow拖拽式画布，节点拖放、连线、配置 |
| 工具栏 | 撤销/重做（Ctrl+Z/Ctrl+Y）、自动排列、居中视图、缩放控制（20%-200%）、验证、保存发布 |
| 节点工具箱 | 左侧可展开/收起，按分类展示节点（流程控制、安全检测、LLM处理、知识检索、数据处理），支持节点搜索过滤 |
| 节点拖拽 | 从工具箱拖拽节点到画布，自动计算位置，支持网格对齐 |
| 节点连线 | 支持节点间连线，自动验证连接有效性，连线动画效果 |
| 节点配置 | 右侧面板配置节点参数，显示节点图标和颜色，支持实时预览 |
| 节点分类 | 流程控制（start、end）、安全检测（safety_check、crisis_intervention）、LLM处理（llm_process）、知识检索（rag_retrieval）、数据处理（text_process） |
| 画布功能 | 网格背景（点状网格）、小地图（右下角，可平移和缩放）、画布缩放（鼠标滚轮）、画布平移（拖拽）、节点选择（点击） |
| 快速创建 | 空画布时提供快速创建基础工作流按钮，自动生成start→safety_check→llm_process→end流程 |
| 工作流验证 | 验证工作流配置的有效性（节点连接、资源配置等），显示验证结果和错误提示 |
| 节点定义 | 获取所有可用节点类型定义（节点类型、名称、图标、颜色、输入输出端口、配置项） |
| 保存 | 保存nodes+edges配置为JSON，标记未保存状态，支持保存为草稿或发布 |
| 启用/禁用 | 禁用时可选同时禁用关联智能体，显示关联智能体数量 |
| 执行引擎 | 支持工作流执行，包含安全检测、知识检索、LLM处理等节点，支持节点间数据流转 |
| 关联查询 | 查询使用该工作流的智能体数量 |
| 工作流状态 | draft（草稿）/ published（已发布）/ archived（已归档） |

#### 3.7.4 模型管理（Admin+）

| 功能 | 说明 |
|-----|------|
| 提供商管理 | CRUD操作，配置名称、API地址、API Key（AES加密存储） |
| 提供商状态 | 支持启用/禁用提供商，显示提供商下的模型数量 |
| 模型管理 | CRUD操作，关联提供商，配置模型名称、类型（chat/embedding）、API地址和Key（可选，为空则使用提供商默认） |
| 模型参数 | temperature、max_tokens、top_p等默认参数（JSON格式），支持编辑 |
| 模型状态 | 支持启用/禁用模型 |
| 对话测试 | 输入测试消息，验证模型API是否可用，显示测试结果 |
| 关联查询 | 查询使用该模型的智能体数量，显示在模型列表中 |

#### 3.7.5 敏感词管理（Admin+）

| 功能 | 说明 |
|-----|------|
| 列表 | 分页展示，支持按分类/动作/状态/关键词筛选 |
| 创建 | 添加敏感词，配置分类、动作、替换文本（可选） |
| 编辑 | 修改敏感词配置 |
| 分类 | general（一般）/ crisis（危机）/ prohibited（禁止） |
| 动作 | block（拦截）/ warn（警告）/ replace（替换）/ intervention（干预） |
| 批量操作 | 批量启用/禁用、批量删除，支持多选操作 |
| 替换文本 | 当动作为replace时，使用replacement字段内容替换 |
| 危机干预 | 检测到危机词汇时，推送心理援助热线信息，支持自定义干预消息 |
| 状态管理 | 支持单个或批量启用/禁用敏感词 |

#### 3.7.6 用户管理（SuperAdmin）

| 功能 | 说明 |
|-----|------|
| 列表 | 分页展示，支持按角色/状态/关键词筛选，显示用户基本信息 |
| 创建 | 创建新用户账号（用户名、密码、昵称、角色） |
| 编辑 | 修改昵称、角色（user/admin/superadmin），查看用户详情 |
| 状态 | 启用/禁用用户账号，支持批量操作 |
| 删除 | 删除用户账号，删除前检查关联数据 |

#### 3.7.7 个人中心（所有用户）

| 功能 | 说明 |
|-----|------|
| 查看资料 | 获取当前用户的个人信息（用户名、昵称、头像、角色、创建时间、账户状态） |
| 资料展示 | 头像大图展示，显示账户类型、注册时间等统计信息 |
| 修改资料 | 修改昵称、个人简介等信息 |
| 修改密码 | 需验证原密码，新密码需确认 |
| 上传头像 | 点击头像区域上传图片，返回头像URL，支持预览 |
| 账户状态 | 显示账户启用/停用状态 |

### 3.8 工作流节点

| 节点类型 | 功能 | 资源依赖 |
|---------|------|---------|
| `start` | 工作流入口，接收用户输入消息 | 无 |
| `text_process` | 文本预处理和清洗，支持文本规范化 | 无 |
| `safety_check` | 内容安全检测与过滤，敏感词检测+危机干预 | 敏感词表 |
| `crisis_intervention` | 危机干预处理，推送心理援助热线 | 无 |
| `rag_retrieval` | 从知识库检索相关内容，向量相似度检索 | 知识库 |
| `llm_process` | 调用AI模型生成回复，支持情绪识别/回复生成 | 模型 |
| `end` | 工作流出口，输出最终回复给用户 | 无 |

### 3.9 RAG服务功能

| 功能 | 说明 |
|-----|------|
| 文本向量化 | 支持单个文本或批量文本向量化，调用嵌入模型（智谱、通义千问等） |
| 文档索引 | 将文档切片向量化后存入ChromaDB，支持批量索引，自动生成向量ID |
| 向量检索 | 在指定知识库中检索相似文档片段，返回Top-K结果及相似度分数，支持相似度阈值过滤 |
| 集合管理 | 支持删除知识库的向量集合，删除单个文档的向量数据，支持批量删除 |
| 统计信息 | 获取知识库集合的统计信息（文档数、片段数、是否存在），用于前端展示 |
| 健康检查 | 提供健康检查接口，返回服务状态和版本信息，用于监控 |
| 错误处理 | 向量化失败时返回错误信息，支持重试机制 |

### 3.10 其他功能

| 功能 | 说明 |
|-----|------|
| 文档切片 | 文档上传后自动按句子切分，支持重叠切片，提高检索准确性 |
| 热度统计 | 智能体热度值统计，每次创建会话时自动增加，用于排序和展示 |
| 会话标题生成 | 首次对话后根据用户输入自动生成会话标题（截取前20字符） |
| 消息分页 | 消息列表支持分页加载，默认每页50条，按时间倒序 |
| 会话分页 | 会话列表支持分页加载，支持多种分页大小（10/20/50/100） |
| 数据统计 | 知识库显示文档数、切片数，工作流显示节点数，模型显示关联智能体数 |
| 状态轮询 | 文档处理状态支持轮询查询，建议每3秒查询一次直到完成或失败 |
| 文件上传 | 支持TXT/MD格式文档上传，最大50MB，使用multipart/form-data格式 |
| Token管理 | JWT Token默认24小时过期，过期后需重新登录 |
| 路由守卫 | 前端路由守卫，自动校验用户登录状态和角色权限 |
| 错误提示 | 统一的错误提示机制，友好的错误信息展示 |
| 加载状态 | 关键操作显示加载状态，提升用户体验 |

---

## 4. 技术架构

### 4.1 系统架构图

```
用户浏览器
    ↓
前端 Vue 3 
    ↓ RESTful API
后端 Spring Boot (:8081)  ──→  LLM API (DeepSeek/智谱/通义千问/豆包)
    ↓ SQL          ↓ HTTP
MySQL     RAG服务 Python  ──→  ChromaDB
```

### 4.2 技术栈

| 层级 | 技术选型 |
|-----|---------|
| **前端** | Vue 3 + Vue Router + Pinia + Element Plus + Tailwind CSS + Vite |
| **后端** | Spring Boot 3.2 + Java 17 + MyBatis + JWT |
| **RAG服务** | Python 3 + FastAPI + ChromaDB |
| **数据库** | MySQL 8.0 |
| **部署** | Docker Compose |

### 4.3 核心设计

- **LLM调用**：Java后端直接调用（OpenAI兼容接口），支持 DeepSeek、智谱、通义千问、豆包等厂商
- **RAG检索**：Python服务负责向量化和检索，通过HTTP接口供后端调用，使用ChromaDB存储向量数据
- **工作流执行**：支持工作流引擎执行，包含安全检测、知识检索、LLM处理等节点，支持节点间数据流转
- **权限控制**：JWT Token + 自定义注解 `@RequireRole`，接口级权限校验
- **数据安全**：密码BCrypt加密，API Key AES加密存储，敏感信息加密传输
- **异步处理**：文档上传后异步切片和向量化，支持重试机制

---

## 5. 非功能性需求

| 需求 | 说明 |
|-----|------|
| 性能 | 支持数十并发用户，LLM响应延迟取决于模型（通常3-10秒） |
| 容错 | LLM调用60秒超时，失败返回友好提示，支持重试机制 |
| 安全 | 密码BCrypt加密，API Key AES加密存储，敏感信息加密传输 |
| 危机干预 | 检测到危机词汇时，自动推送心理援助热线信息（400-161-9995） |
| 数据持久化 | 所有数据持久化到MySQL，向量数据存储到ChromaDB |
| 异步处理 | 文档上传后异步切片和向量化，不阻塞用户操作 |
| 接口限流 | 建议前端对消息发送接口做防抖处理，避免重复请求 |
| 文件大小限制 | 文档上传最大50MB，单页数据最大100条 |
| 响应式设计 | 前端支持PC端和移动端响应式布局 |
| 浏览器兼容 | 支持现代浏览器（Chrome、Firefox、Safari、Edge） |
