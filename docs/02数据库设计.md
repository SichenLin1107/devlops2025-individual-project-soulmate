# 📊 SoulMate 心伴 - 数据库设计

> **SoulMate** - 您的AI心灵伴侣

## 1. 数据库设计概述

### 1.1 技术选型
- **数据库**：MySQL 8.0+
- **字符集**：utf8mb4_unicode_ci（支持完整的UTF-8字符集）
- **存储引擎**：InnoDB（支持事务和外键约束）

### 1.2 设计原则
- **规范化设计**：遵循第三范式，避免数据冗余
- **性能优化**：合理设置索引，优化查询性能
- **扩展性**：预留扩展字段，支持业务发展
- **安全性**：敏感数据加密存储，设置合理的约束
- **完整性**：通过外键约束保证数据完整性

### 1.3 数据域划分

| 数据域 | 核心表 | 说明 |
|--------|--------|------|
| **System** | `sys_user`, `sys_sensitive_word` | 用户认证、敏感词 |
| **LLM** | `llm_provider`, `llm_model` | 模型提供商与模型配置 |
| **Knowledge** | `ai_knowledge_base`, `ai_knowledge_document`, `ai_knowledge_segment` | RAG知识库 |
| **Agent** | `ai_agent`, `ai_workflow`, `ai_agent_knowledge` | 智能体与工作流 |
| **Chat** | `chat_session`, `chat_message` | 会话与消息 |

**总计**：12 张核心表

### 1.4 ID 设计规范

| 实体 | ID格式 | 示例 |
|-----|--------|------|
| 用户 | `usr_` + UUID短码 | `usr_a1b2c3d4` |
| 智能体 | `agt_` + UUID短码 | `agt_e5f6g7h8` |
| 工作流 | `wfl_` + UUID短码 | `wfl_i9j0k1l2` |
| 知识库 | `kb_` + UUID短码 | `kb_m3n4o5p6` |
| 提供商 | `prv_` + UUID短码 | `prv_q7r8s9t0` |
| 模型 | `mdl_` + UUID短码 | `mdl_u1v2w3x4` |

从属表（文档、切片、会话、消息等）使用 `BIGINT AUTO_INCREMENT`。

ID生成工具类：`com.soulmate.util.IdGenerator`

---

## 2. 数据库表设计

### 2.1 System 域 - 用户与安全

#### 2.1.1 `sys_user` 用户表

存储平台用户信息，支持 User/Admin/SuperAdmin 角色区分。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | varchar(32) | 是 | - | 用户ID (usr_xxx)，主键 |
| username | varchar(50) | 是 | - | 登录账号，唯一 |
| password | varchar(100) | 是 | - | 密码 (BCrypt加密) |
| role | varchar(20) | 是 | 'user' | 角色: user-普通用户, admin-管理员, superadmin-超级管理员 |
| nickname | varchar(50) | 否 | NULL | 昵称 |
| avatar | varchar(255) | 否 | NULL | 头像URL |
| bio | varchar(200) | 否 | NULL | 个人简介 |
| status | tinyint | 是 | 1 | 状态: 1-正常, 0-禁用 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `sys_user` (
  `id` varchar(32) NOT NULL COMMENT '用户ID (usr_xxx)',
  `username` varchar(50) NOT NULL COMMENT '登录账号',
  `password` varchar(100) NOT NULL COMMENT '密码 (BCrypt加密)',
  `role` varchar(20) NOT NULL DEFAULT 'user' COMMENT '角色: user-普通用户, admin-管理员, superadmin-超级管理员',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `bio` varchar(200) DEFAULT NULL COMMENT '个人简介',
  `status` tinyint NOT NULL DEFAULT 1 COMMENT '状态: 1-正常, 0-禁用',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_role` (`role`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

**场景支撑**：用户登录对话、个人信息管理

**实现说明**：
- 密码使用 BCrypt 加密存储（Spring Security `PasswordEncoder`）
- 角色字段：`user`（普通用户）、`admin`（管理员）、`superadmin`（超级管理员）
- 状态字段：`1`（正常）、`0`（禁用），禁用用户无法登录
- 用户ID使用 `usr_` 前缀，由 `IdGenerator.userId()` 生成

---

#### 2.1.2 `sys_sensitive_word` 敏感词表

维护敏感词库，支持心理陪伴场景的安全风控。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 主键 |
| word | varchar(50) | 是 | - | 敏感词，唯一 |
| category | varchar(20) | 是 | 'general' | 分类: general-通用, crisis-危机干预, prohibited-禁止词 |
| action | varchar(20) | 是 | 'block' | 处理动作: block-拦截, warn-警告, replace-替换, intervention-危机干预 |
| replacement | varchar(50) | 否 | NULL | 替换文本 (action=replace时使用) |
| is_active | tinyint | 是 | 1 | 是否启用: 1-是, 0-否 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE `sys_sensitive_word` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键',
  `word` varchar(50) NOT NULL COMMENT '敏感词',
  `category` varchar(20) NOT NULL DEFAULT 'general' COMMENT '分类: general-通用, crisis-危机干预, prohibited-禁止词',
  `action` varchar(20) NOT NULL DEFAULT 'block' COMMENT '处理动作: block-拦截, warn-警告, replace-替换, intervention-危机干预',
  `replacement` varchar(50) DEFAULT NULL COMMENT '替换文本 (action=replace时使用)',
  `is_active` tinyint NOT NULL DEFAULT 1 COMMENT '是否启用: 1-是, 0-否',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_word` (`word`),
  KEY `idx_category_active` (`category`, `is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='敏感词表';
```

**场景支撑**：安全风控与危机干预

**分类说明**：
- `general`：一般敏感词（脏话、不当言论等）
- `crisis`：危机干预词（轻生、自伤相关），触发时推送心理援助信息
- `prohibited`：绝对禁止词，直接拦截

**处理动作说明**：
- `block`：直接拦截，不发送给 LLM
- `warn`：发送警告提示，继续处理
- `replace`：用 `replacement` 字段内容替换敏感词
- `intervention`：触发危机干预流程，推送心理援助热线等信息

**实现说明**：
- 敏感词唯一性约束（`uk_word`），同一敏感词不能重复添加
- 支持启用/禁用（`is_active`），禁用的敏感词不参与检测
- 管理接口需要 Admin 或 SuperAdmin 权限

---

### 2.2 LLM 域 - 大模型管理

#### 2.2.1 `llm_provider` LLM 提供商表

管理 LLM 服务提供商的基础信息。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | varchar(32) | 是 | - | 提供商ID (prv_xxx)，主键 |
| name | varchar(50) | 是 | - | 提供商名称 |
| api_base | varchar(255) | 否 | NULL | API 基础地址 |
| api_key | varchar(255) | 否 | NULL | API 密钥 (AES加密存储) |
| is_active | tinyint | 是 | 1 | 是否启用: 1-是, 0-否 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `llm_provider` (
  `id` varchar(32) NOT NULL COMMENT '提供商ID (prv_xxx)',
  `name` varchar(50) NOT NULL COMMENT '提供商名称',
  `api_base` varchar(255) DEFAULT NULL COMMENT 'API 基础地址',
  `api_key` varchar(255) DEFAULT NULL COMMENT 'API 密钥 (AES加密存储)',
  `is_active` tinyint NOT NULL DEFAULT 1 COMMENT '是否启用: 1-是, 0-否',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='LLM提供商表';
```

**场景支撑**：管理员管理大模型

---

#### 2.2.2 `llm_model` LLM 模型表

存储具体模型配置及默认参数，供智能体和工作流选用。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | varchar(32) | 是 | - | 模型ID (mdl_xxx)，主键 |
| provider_id | varchar(32) | 是 | - | 所属提供商ID |
| name | varchar(50) | 是 | - | 模型名称 (如 deepseek-chat) |
| display_name | varchar(50) | 是 | - | 显示名称 (如 DeepSeek V3) |
| model_type | varchar(20) | 是 | 'chat' | 模型类型: chat-对话, embedding-向量 |
| api_base | varchar(255) | 否 | NULL | API 地址 (为空则使用提供商默认) |
| api_key | varchar(255) | 否 | NULL | API 密钥 (AES加密存储，为空则使用提供商默认) |
| default_config | json | 否 | NULL | 默认配置参数 |
| is_active | tinyint | 是 | 1 | 是否启用: 1-是, 0-否 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `llm_model` (
  `id` varchar(32) NOT NULL COMMENT '模型ID (mdl_xxx)',
  `provider_id` varchar(32) NOT NULL COMMENT '所属提供商ID',
  `name` varchar(50) NOT NULL COMMENT '模型名称 (如 deepseek-chat)',
  `display_name` varchar(50) NOT NULL COMMENT '显示名称 (如 DeepSeek V3)',
  `model_type` varchar(20) NOT NULL DEFAULT 'chat' COMMENT '模型类型: chat-对话, embedding-向量',
  `api_base` varchar(255) DEFAULT NULL COMMENT 'API 地址 (为空则使用提供商默认)',
  `api_key` varchar(255) DEFAULT NULL COMMENT 'API 密钥 (AES加密存储，为空则使用提供商默认)',
  `default_config` json DEFAULT NULL COMMENT '默认配置参数',
  `is_active` tinyint NOT NULL DEFAULT 1 COMMENT '是否启用: 1-是, 0-否',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_provider` (`provider_id`),
  KEY `idx_type_active` (`model_type`, `is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='LLM模型表';
```

**场景支撑**：管理员管理大模型、工作流绑定 LLM_w、智能体绑定 LLM_a

**`default_config` 字段说明**：

```json
{
    "temperature": 0.7,        // 温度 (0.0-2.0)，控制输出随机性，心理陪伴建议 0.7-0.9
    "top_p": 0.9,              // 核采样 (0.0-1.0)，控制词汇多样性
    "max_tokens": 2000,        // 最大输出 Token 数
    "presence_penalty": 0.0,   // 存在惩罚 (-2.0-2.0)，减少重复话题
    "frequency_penalty": 0.0   // 频率惩罚 (-2.0-2.0)，减少重复用词
}
```

**实现说明**：
- API Key 使用 AES 加密存储（`EncryptionUtil`），配置项：`encryption.secret-key`
- 模型级 API Key 优先，为空时使用提供商级 API Key
- 模型级 `api_base` 优先，为空时使用提供商级 `api_base`
- 删除模型前需检查是否被智能体使用（`ai_agent.model_id`）
- 管理接口需要 Admin 或 SuperAdmin 权限

---

### 2.3 Knowledge 域 - 知识库管理

#### 2.3.1 `ai_knowledge_base` 知识库表

存储知识库元数据，支持 RAG 检索。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | varchar(32) | 是 | - | 知识库ID (kb_xxx)，主键 |
| name | varchar(50) | 是 | - | 知识库名称 |
| description | varchar(200) | 否 | NULL | 描述 |
| embedding_model | varchar(32) | 否 | NULL | 使用的向量模型ID |
| doc_count | int | 是 | 0 | 文档数量 |
| segment_count | int | 是 | 0 | 切片数量 |
| is_active | tinyint | 是 | 1 | 是否启用: 1-是, 0-否 |
| created_by | varchar(32) | 是 | - | 创建者ID |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `ai_knowledge_base` (
  `id` varchar(32) NOT NULL COMMENT '知识库ID (kb_xxx)',
  `name` varchar(50) NOT NULL COMMENT '知识库名称',
  `description` varchar(200) DEFAULT NULL COMMENT '描述',
  `embedding_model` varchar(32) DEFAULT NULL COMMENT '使用的向量模型ID',
  `doc_count` int NOT NULL DEFAULT 0 COMMENT '文档数量',
  `segment_count` int NOT NULL DEFAULT 0 COMMENT '切片数量',
  `is_active` tinyint NOT NULL DEFAULT 1 COMMENT '是否启用: 1-是, 0-否',
  `created_by` varchar(32) NOT NULL COMMENT '创建者ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_created_by` (`created_by`),
  KEY `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='知识库表';
```

**场景支撑**：管理员配置知识库

**实现说明**：
- 知识库ID使用 `kb_` 前缀，由 `IdGenerator.knowledgeBaseId()` 生成
- 统计信息自动更新：文档上传时 `doc_count + 1`，文档处理完成时 `segment_count` 更新
- 管理接口需要 Admin 或 SuperAdmin 权限

---

#### 2.3.2 `ai_knowledge_document` 知识库文档表

记录上传到知识库的原始文档信息。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 文档ID，主键 |
| kb_id | varchar(32) | 是 | - | 所属知识库ID |
| file_name | varchar(100) | 是 | - | 文件名 |
| file_type | varchar(10) | 是 | - | 文件类型: txt, md, pdf, doc, docx |
| file_size | int | 是 | - | 文件大小 (字节) |
| file_path | varchar(255) | 是 | - | 文件存储路径 |
| segment_count | int | 是 | 0 | 切片数量 |
| status | varchar(20) | 是 | 'pending' | 状态: pending-待处理, processing-处理中, completed-已完成, failed-失败 |
| retry_count | int | 是 | 0 | 重试次数 |
| error_message | text | 否 | NULL | 错误信息 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `ai_knowledge_document` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '文档ID',
  `kb_id` varchar(32) NOT NULL COMMENT '所属知识库ID',
  `file_name` varchar(100) NOT NULL COMMENT '文件名',
  `file_type` varchar(10) NOT NULL COMMENT '文件类型: txt, md, pdf, doc, docx',
  `file_size` int NOT NULL COMMENT '文件大小 (字节)',
  `file_path` varchar(255) NOT NULL COMMENT '文件存储路径',
  `segment_count` int NOT NULL DEFAULT 0 COMMENT '切片数量',
  `status` varchar(20) NOT NULL DEFAULT 'pending' COMMENT '状态: pending-待处理, processing-处理中, completed-已完成, failed-失败',
  `retry_count` int NOT NULL DEFAULT 0 COMMENT '重试次数',
  `error_message` text DEFAULT NULL COMMENT '错误信息',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_kb_id` (`kb_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='知识库文档表';
```

**场景支撑**：管理员上传文档

**实现说明**：
- 文档状态流转：`pending` → `processing` → `completed` / `failed`
- 重试机制：`retry_count` 字段记录重试次数，最多重试3次
- 错误信息：`error_message` 字段记录处理失败时的错误详情
- 文件存储：文件保存在 `uploads/knowledge/{kbId}/` 目录

---

#### 2.3.3 `ai_knowledge_segment` 知识切片表

存储文档切片内容及向量索引关联。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 切片ID，主键 |
| kb_id | varchar(32) | 是 | - | 所属知识库ID |
| doc_id | bigint | 是 | - | 来源文档ID |
| content | text | 是 | - | 切片文本内容 |
| vector_id | varchar(64) | 否 | NULL | ChromaDB 向量ID |
| word_count | int | 是 | 0 | 字数 |
| position | int | 是 | 0 | 在文档中的位置序号 |
| status | tinyint | 是 | 1 | 状态: 1-有效, 0-已删除 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `ai_knowledge_segment` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '切片ID',
  `kb_id` varchar(32) NOT NULL COMMENT '所属知识库ID',
  `doc_id` bigint NOT NULL COMMENT '来源文档ID',
  `content` text NOT NULL COMMENT '切片文本内容',
  `vector_id` varchar(64) DEFAULT NULL COMMENT 'ChromaDB 向量ID',
  `word_count` int NOT NULL DEFAULT 0 COMMENT '字数',
  `position` int NOT NULL DEFAULT 0 COMMENT '在文档中的位置序号',
  `status` tinyint NOT NULL DEFAULT 1 COMMENT '状态: 1-有效, 0-已删除',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_kb_status` (`kb_id`, `status`),
  KEY `idx_doc_id` (`doc_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='知识切片表';
```

**场景支撑**：切片管理、检索测试

---

### 2.4 Agent 域 - 智能体与工作流

#### 2.4.1 `ai_workflow` 工作流表

存储工作流配置，支持拖拽式节点编排。**资源绑定在节点级别**，每个节点独立声明所需的 LLM 或知识库。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | varchar(32) | 是 | - | 工作流ID (wfl_xxx)，主键 |
| name | varchar(50) | 是 | - | 工作流名称 |
| description | varchar(200) | 否 | NULL | 描述 |
| nodes_config | json | 是 | - | 节点与连线配置 (资源绑定在节点内) |
| status | varchar(20) | 是 | 'draft' | 工作流状态: draft-草稿, published-已发布, archived-已归档 |
| validation_status | varchar(20) | 否 | NULL | 验证状态: valid-通过, invalid-未通过, warning-有警告 |
| node_count | int | 是 | 0 | 节点数量 |
| node_types | json | 否 | NULL | 节点类型列表，如 ["start", "text_process", "safety_check", "rag_retrieval", "llm_process", "end"] |
| has_rag | tinyint | 是 | 0 | 是否包含RAG节点: 1-是, 0-否 |
| has_crisis_intervention | tinyint | 是 | 0 | 是否包含安全检测节点（safety_check）: 1-是, 0-否 |
| is_active | tinyint | 是 | 0 | 是否启用: 1-是, 0-否（只有published状态才能启用） |
| created_by | varchar(32) | 是 | - | 创建者ID |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |

```sql
CREATE TABLE `ai_workflow` (
  `id` varchar(32) NOT NULL COMMENT '工作流ID (wfl_xxx)',
  `name` varchar(50) NOT NULL COMMENT '工作流名称',
  `description` varchar(200) DEFAULT NULL COMMENT '描述',
  `nodes_config` json NOT NULL COMMENT '节点与连线配置 (资源绑定在节点内)',
  `status` varchar(20) NOT NULL DEFAULT 'draft' COMMENT '工作流状态: draft-草稿, published-已发布, archived-已归档',
  `validation_status` varchar(20) DEFAULT NULL COMMENT '验证状态: valid-通过, invalid-未通过, warning-有警告',
  `node_count` int NOT NULL DEFAULT 0 COMMENT '节点数量',
  `node_types` json DEFAULT NULL COMMENT '节点类型列表',
  `has_rag` tinyint NOT NULL DEFAULT 0 COMMENT '是否包含RAG节点: 1-是, 0-否',
  `has_crisis_intervention` tinyint NOT NULL DEFAULT 0 COMMENT '是否包含安全检测节点（safety_check）: 1-是, 0-否',
  `is_active` tinyint NOT NULL DEFAULT 0 COMMENT '是否启用: 1-是, 0-否（只有published状态才能启用）',
  `created_by` varchar(32) NOT NULL COMMENT '创建者ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_created_by` (`created_by`),
  KEY `idx_status` (`status`),
  KEY `idx_is_active` (`is_active`),
  KEY `idx_has_rag` (`has_rag`),
  KEY `idx_has_crisis_intervention` (`has_crisis_intervention`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='工作流表';
```

**场景支撑**：管理员编辑工作流

**设计说明**：
- 资源（LLM、知识库）绑定在**节点级别**的 `config` 中
- `nodes_config` 存储完整的节点和连线配置（JSON格式）
- 元数据字段（`node_count`、`has_rag`等）在保存时自动计算

**`nodes_config` 结构示例**：

```json
{
    "nodes": [
        { "id": "start", "type": "start", "name": "开始", "config": {}, "position": { "x": 100, "y": 200 } },
        { "id": "safety", "type": "safety_check", "name": "安全检测", "config": {...}, "position": { "x": 300, "y": 200 } },
        { "id": "rag", "type": "rag_retrieval", "name": "知识检索", "config": { "kb_id": "kb_xxx", "top_k": 3 }, "position": { "x": 500, "y": 200 } },
        { "id": "llm", "type": "llm_process", "name": "LLM处理", "config": { "model_id": "mdl_xxx" }, "position": { "x": 700, "y": 200 } },
        { "id": "end", "type": "end", "name": "结束", "config": {}, "position": { "x": 900, "y": 200 } }
    ],
    "edges": [
        { "source": "start", "target": "safety" },
        { "source": "safety", "target": "rag" },
        { "source": "rag", "target": "llm" },
        { "source": "llm", "target": "end" }
    ]
}
```

**节点类型**（7个）：

| 类型 | 名称 | 资源依赖 | 说明 |
|-----|------|---------|------|
| `start` | 开始 | 无 | 工作流入口 |
| `text_process` | 文本处理 | 无 | 文本清洗、格式化 |
| `safety_check` | 安全检测 | 无 | 敏感词检测+危机干预 |
| `rag_retrieval` | 知识检索 | `kb_id` | 向量检索 |
| `llm_process` | LLM处理 | `model_id` | LLM调用 |
| `crisis_intervention` | 危机干预 | 无 | 危机干预响应 |
| `end` | 结束 | 无 | 工作流出口 |

---

#### 2.4.2 `ai_agent` 智能体表

存储智能体完整配置，包含人设、开场白、模型配置等核心信息。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | varchar(32) | 是 | - | 智能体ID (agt_xxx)，主键 |
| name | varchar(50) | 是 | - | 智能体名称 |
| avatar | varchar(255) | 否 | NULL | 头像URL |
| description | varchar(500) | 否 | NULL | 简介 (展示在广场) |
| tags | varchar(100) | 否 | NULL | 标签 (逗号分隔，如: 情感,职场,压力) |
| greeting | varchar(500) | 是 | '你好，我是你的心理陪伴伙伴，有什么想和我聊聊的吗？' | 开场白 |
| system_prompt | text | 是 | - | 系统提示词 (人设) |
| model_id | varchar(32) | 是 | - | Agent 层 LLM_a 模型ID |
| model_config | json | 否 | NULL | LLM_a 参数覆盖配置 |
| workflow_id | varchar(32) | 否 | NULL | 关联的工作流ID（一个智能体只能关联一个工作流，可为空表示不使用工作流） |
| status | varchar(10) | 是 | 'offline' | 状态: published-已上架(启用), offline-已下架 |
| heat_value | int | 是 | 0 | 热度值 (对话次数) |
| created_by | varchar(32) | 是 | - | 创建者ID |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 更新时间 |
| published_at | datetime | 否 | NULL | 上架时间 |

```sql
CREATE TABLE `ai_agent` (
  `id` varchar(32) NOT NULL COMMENT '智能体ID (agt_xxx)',
  `name` varchar(50) NOT NULL COMMENT '智能体名称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `description` varchar(500) DEFAULT NULL COMMENT '简介 (展示在广场)',
  `tags` varchar(100) DEFAULT NULL COMMENT '标签 (逗号分隔，如: 情感,职场,压力)',
  `greeting` varchar(500) NOT NULL DEFAULT '你好，我是你的心理陪伴伙伴，有什么想和我聊聊的吗？' COMMENT '开场白',
  `system_prompt` text NOT NULL COMMENT '系统提示词 (人设)',
  `model_id` varchar(32) NOT NULL COMMENT 'Agent 层 LLM_a 模型ID',
  `model_config` json DEFAULT NULL COMMENT 'LLM_a 参数覆盖配置',
  `workflow_id` varchar(32) DEFAULT NULL COMMENT '关联的工作流ID（一个智能体只能关联一个工作流，可为空表示不使用工作流）',
  `status` varchar(10) NOT NULL DEFAULT 'offline' COMMENT '状态: published-已上架(启用), offline-已下架',
  `heat_value` int NOT NULL DEFAULT 0 COMMENT '热度值 (对话次数)',
  `created_by` varchar(32) NOT NULL COMMENT '创建者ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `published_at` datetime DEFAULT NULL COMMENT '上架时间',
  PRIMARY KEY (`id`),
  KEY `idx_status_heat` (`status`, `heat_value` DESC),
  KEY `idx_created_by` (`created_by`),
  KEY `idx_model_id` (`model_id`),
  KEY `idx_workflow_id` (`workflow_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='智能体表';
```

**场景支撑**：智能体广场展示、智能体组装与发布

**状态说明**：
- `published`（已上架）：智能体在广场展示，用户可以创建会话并使用
- `offline`（已下架）：智能体不在广场展示，但保留所有配置，管理员可以重新启用
- **注意**：智能体只有上架和下架两种状态，没有草稿状态。新建智能体默认状态为下架（offline）

**实现说明**：
- 智能体ID使用 `agt_` 前缀，由 `IdGenerator.agentId()` 生成
- 热度统计：每次创建 `session_type='normal'` 的会话时，`heat_value += 1`
- 工作流关联：一个智能体只能关联一个工作流（`workflow_id` 可为空）
- 知识库绑定：通过 `ai_agent_knowledge` 关联表实现多对多关系（Agent层KB_a）
- 管理接口需要 Admin 或 SuperAdmin 权限

**工作流关联说明**：
- 一个智能体**只能关联一个工作流**（通过 `workflow_id` 字段）
- `workflow_id` 可为 `NULL`，表示该智能体不使用工作流，直接由 Agent 层的 LLM_a 生成回复
- 工作流与智能体是一对一关系，不支持一个智能体关联多个工作流

**`system_prompt` 人设示例（心理陪伴场景）**：

```
你是一位温暖、专业的心理陪伴师，名叫「暖心」。

【核心身份】
- 你是一个善于倾听、富有同理心的 AI 陪伴者
- 你的目标是为用户提供情绪支持和心灵慰藉

【沟通风格】
- 语气温和、亲切，像一位理解你的老朋友
- 善于使用开放式问题引导用户表达
- 会适时给予肯定和鼓励

【行为边界】
- 你提供的是情绪陪伴，不是专业心理咨询或医疗诊断
- 当用户表现出严重心理危机时，引导其寻求专业帮助
- 不评判用户的想法和感受，保持中立和接纳

【回复要求】
- 回复长度适中，避免过于冗长
- 多使用共情性语句，如"我能理解你的感受"
- 每次回复都要关注用户的情绪状态
```

**`model_config` 参数覆盖配置**：

```json
{
    "temperature": 0.8,
    "max_tokens": 1500
}
```

> 未指定的参数使用 `llm_model.default_config` 中的默认值

---

#### 2.4.3 `ai_agent_knowledge` 智能体-知识库关联表

实现智能体与知识库的多对多关联（KB_a）。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 主键 |
| agent_id | varchar(32) | 是 | - | 智能体ID |
| kb_id | varchar(32) | 是 | - | 知识库ID |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE `ai_agent_knowledge` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键',
  `agent_id` varchar(32) NOT NULL COMMENT '智能体ID',
  `kb_id` varchar(32) NOT NULL COMMENT '知识库ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_agent_kb` (`agent_id`, `kb_id`),
  KEY `idx_agent_id` (`agent_id`),
  KEY `idx_kb_id` (`kb_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='智能体-知识库关联表';
```

**场景支撑**：智能体关联 KB_a

---

### 2.5 Chat 域 - 会话与消息

#### 2.5.1 `chat_session` 会话表

存储用户与智能体的会话记录。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 会话ID，主键 |
| user_id | varchar(32) | 是 | - | 用户ID |
| agent_id | varchar(32) | 是 | - | 智能体ID |
| title | varchar(50) | 是 | '新对话' | 会话标题 |
| session_type | varchar(10) | 是 | 'normal' | 会话类型: normal-普通, debug-调试 |
| is_pinned | tinyint | 是 | 0 | 是否置顶: 1-是, 0-否 |
| message_count | int | 是 | 0 | 消息数量 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | datetime | 是 | CURRENT_TIMESTAMP | 最后活跃时间 |

```sql
CREATE TABLE `chat_session` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '会话ID',
  `user_id` varchar(32) NOT NULL COMMENT '用户ID',
  `agent_id` varchar(32) NOT NULL COMMENT '智能体ID',
  `title` varchar(50) NOT NULL DEFAULT '新对话' COMMENT '会话标题',
  `session_type` varchar(10) NOT NULL DEFAULT 'normal' COMMENT '会话类型: normal-普通, debug-调试',
  `is_pinned` tinyint NOT NULL DEFAULT 0 COMMENT '是否置顶: 1-是, 0-否',
  `message_count` int NOT NULL DEFAULT 0 COMMENT '消息数量',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后活跃时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_agent` (`user_id`, `agent_id`),
  KEY `idx_user_pinned_time` (`user_id`, `is_pinned` DESC, `updated_at` DESC),
  KEY `idx_agent_id` (`agent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='会话表';
```

**场景支撑**：对话体验、会话管理、调试会话

**会话类型说明**：
- `normal`：普通用户会话，计入智能体热度
- `debug`：管理员调试会话，不计入热度统计

---

#### 2.5.2 `chat_message` 消息表

存储会话中的具体消息内容。

**字段信息：**

| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | bigint | 是 | AUTO_INCREMENT | 消息ID，主键 |
| session_id | bigint | 是 | - | 会话ID |
| role | varchar(10) | 是 | - | 角色: user-用户, assistant-助手, system-系统 |
| content | text | 是 | - | 消息内容 |
| msg_type | varchar(20) | 是 | 'text' | 消息类型: text-文本, greeting-开场白, crisis_alert-危机干预 |
| emotion | varchar(20) | 否 | NULL | 识别的情绪标签 |
| token_count | int | 否 | NULL | Token 消耗数 |
| created_at | datetime | 是 | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE `chat_message` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '消息ID',
  `session_id` bigint NOT NULL COMMENT '会话ID',
  `role` varchar(10) NOT NULL COMMENT '角色: user-用户, assistant-助手, system-系统',
  `content` text NOT NULL COMMENT '消息内容',
  `msg_type` varchar(20) NOT NULL DEFAULT 'text' COMMENT '消息类型: text-文本, greeting-开场白, crisis_alert-危机干预',
  `emotion` varchar(20) DEFAULT NULL COMMENT '识别的情绪标签',
  `token_count` int DEFAULT NULL COMMENT 'Token 消耗数',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_session_time` (`session_id`, `created_at`),
  KEY `idx_session_id` (`session_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='消息表';
```

**场景支撑**：对话记录、危机干预记录

**消息类型说明**：
- `text`：普通文本消息
- `greeting`：智能体开场白
- `crisis_alert`：危机干预消息（心理援助热线、安抚话语等）

---

## 3. 表关系简图

```
sys_user ──1:N──► ai_agent ──N:1──► llm_model ◄──N:1── llm_provider
              │           │
              │           ├──N:1──► ai_workflow
              │           │
              │           └──M:N──► ai_knowledge_base ◄── ai_agent_knowledge
              │
              └──1:N──► chat_session ──1:N──► chat_message

ai_knowledge_base ──1:N──► ai_knowledge_document ──1:N──► ai_knowledge_segment
```

**资源绑定**：
- **智能体层**：`ai_agent.model_id` 关联模型，`ai_agent_knowledge` 关联知识库
- **工作流层**：节点配置中 `config.model_id` / `config.kb_id` 引用资源

---

## 4. 初始化数据

### 4.1 用户账号

```sql
-- 超级管理员账号（密码: superadmin123，BCrypt加密）
INSERT INTO sys_user (id, username, password, role, nickname, status) VALUES
('usr_superadmin', 'superadmin', '$2a$10$N.ZOn9G6/YLFixAOPMg/h.z7pCu6v2XyFDtC4q.jeeGM/TEZyj.DK', 'superadmin', '超级管理员', 1);
-- 密码明文: superadmin123

-- 管理员账号（密码: admin123，BCrypt加密）
INSERT INTO sys_user (id, username, password, role, nickname, status) VALUES
('usr_admin', 'admin', '$2a$10$N.ZOn9G6/YLFixAOPMg/h.z7pCu6v2XyFDtC4q.jeeGM/TEZyj.DK', 'admin', '系统管理员', 1);
-- 密码明文: admin123
```

### 4.2 LLM 提供商与模型

```sql
-- 提供商
INSERT INTO llm_provider (id, name, api_base, is_active) VALUES
('prv_deepseek', 'DeepSeek', 'https://api.deepseek.com', 1),
('prv_zhipu', '智谱AI', 'https://open.bigmodel.cn/api/paas/v4', 1);

-- 模型
INSERT INTO llm_model (id, provider_id, name, display_name, model_type, default_config, is_active) VALUES
('mdl_deepseek_chat', 'prv_deepseek', 'deepseek-chat', 'DeepSeek Chat', 'chat', 
 '{"temperature": 0.7, "top_p": 0.9, "max_tokens": 2000, "presence_penalty": 0, "frequency_penalty": 0}', 1),
('mdl_glm4_flash', 'prv_zhipu', 'glm-4-flash', 'GLM-4 Flash', 'chat',
 '{"temperature": 0.7, "top_p": 0.9, "max_tokens": 2000, "presence_penalty": 0, "frequency_penalty": 0}', 1),
('mdl_embedding', 'prv_zhipu', 'embedding-3', '智谱 Embedding', 'embedding', NULL, 1);
```

### 4.3 敏感词初始数据

```sql
INSERT INTO sys_sensitive_word (word, category, action, replacement, is_active) VALUES
-- 危机干预词
('自杀', 'crisis', 'warn', NULL, 1),
('不想活', 'crisis', 'warn', NULL, 1),
('轻生', 'crisis', 'warn', NULL, 1),
('结束生命', 'crisis', 'warn', NULL, 1),
-- 禁止词示例
('违禁词示例', 'prohibited', 'block', NULL, 1);
```

---

## 5. 索引设计说明

| 表 | 索引 | 用途 |
|---|------|------|
| `sys_user` | `uk_username` | 登录时快速查找用户 |
| `sys_user` | `idx_role`, `idx_status` | 按角色和状态筛选用户 |
| `sys_sensitive_word` | `idx_category_active` | 按分类加载启用的敏感词 |
| `llm_model` | `idx_type_active` | 按类型筛选可用模型 |
| `ai_knowledge_segment` | `idx_kb_status` | 加载知识库的有效切片 |
| `ai_agent` | `idx_status_heat` | 广场按热度排序展示 |
| `chat_session` | `idx_user_pinned_time` | 用户会话列表（置顶优先，时间倒序） |
| `chat_message` | `idx_session_time` | 加载会话消息（时间正序） |

---

## 6. 向量存储设计

系统使用 **ChromaDB** 存储向量数据，与 MySQL 通过 `vector_id` 关联。

### 6.1 Collection 设计

```python
# 每个知识库对应一个 Collection，使用知识库ID作为名称
# 例如：知识库 kb_psychology 对应 collection "kb_psychology"
collection_name = kb_id  # kb_id 本身已是 "kb_xxx" 格式

# 存储结构
{
    "ids": ["seg_1", "seg_2", ...],           # 对应 ai_knowledge_segment.id
    "embeddings": [[0.1, 0.2, ...], ...],     # 向量数据
    "metadatas": [
        {"kb_id": "kb_psychology", "doc_id": 1, "position": 0},
        ...
    ],
    "documents": ["切片文本内容", ...]          # 原始文本
}
```

### 6.2 同步策略

- **新增切片**：MySQL 插入 → 向量化 → ChromaDB 插入 → 更新 `vector_id`
- **删除切片**：ChromaDB 删除 → MySQL 软删除（`status = 0`）
- **知识库删除**：删除整个 Collection → MySQL 级联删除

---

## 7. 表关系 ER 图

```
sys_user ─────────────────────────────────────┐
    │                                         │
    │ 1:N                                     │ 1:N
    ▼                                         ▼
ai_agent ◄──────────────── ai_agent_knowledge
    │    \                        │
    │     \  N:1                  │ N:1
    │      ▼                      ▼
    │   llm_model          ai_knowledge_base
    │       ▲                     │
    │       │                     │ 1:N
    │  N:1  │                     ▼
    ▼       │              ai_knowledge_document
ai_workflow │                     │
    │       │                     │ 1:N
    │ (节点内 model_id            ▼
    │  引用 llm_model)     ai_knowledge_segment
    │       │
    │ (节点内 kb_id
    │  引用 ai_knowledge_base)
    │
    └─ nodes_config (JSON) 存储节点级资源绑定


llm_provider ──── 1:N ────► llm_model


chat_session ─────────────────┐
    │                         │
    │ N:1                     │ N:1
    ▼                         ▼
sys_user                  ai_agent
    
chat_session ──── 1:N ────► chat_message
```

**说明**：
- `ai_agent.model_id` 直接关联 `llm_model`（Agent 层 LLM_a）
- `ai_workflow.nodes_config` 中各节点的 `model_id`、`kb_id` 为 JSON 内的逻辑引用
- 工作流节点可引用多个不同的 LLM 和知识库

---

## 8. 补充说明

### 8.1 配置优先级

LLM参数：智能体/节点配置 > 模型默认配置 > 系统默认值

### 8.2 热度统计

`session_type = 'normal'` 的会话创建时 `heat_value += 1`，调试会话不计入

### 8.3 安全

- 密码：BCrypt加密
- API Key：AES加密
- 对话内容：生产环境日志脱敏

### 8.4 性能优化建议

1. **分区策略**: 对于消息表可以按时间分区，提高查询性能
2. **读写分离**: 对于查询频繁的表可以考虑读写分离
3. **缓存策略**: 智能体信息、知识库信息等可以使用Redis缓存
4. **归档策略**: 定期归档历史消息数据
